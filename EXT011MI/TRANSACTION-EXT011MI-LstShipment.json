{"programModules":{"EXT011MI":{"program":"EXT011MI","triggers":{},"transactions":{"LstShipment":{"sourceUuid":"202c6506-3e46-4050-9cda-327cd61c134b","name":"LstShipment","program":"EXT011MI","description":"List Shipment Lines","active":true,"multi":true,"modified":1705927067675,"modifiedBy":"ABHISHEK","outputFields":[{"name":"PRID","description":"Product ID","length":15,"mandatory":false,"type":"A"},{"name":"UST1","description":"User string 1","length":20,"mandatory":false,"type":"A"},{"name":"QTY1","description":"Quantity 1","length":15,"mandatory":false,"type":"N"},{"name":"UST2","description":"User string 2","length":20,"mandatory":false,"type":"A"},{"name":"RFTX","description":"Reference text","length":40,"mandatory":false,"type":"A"},{"name":"CITC","description":"Commodity Item Code","length":15,"mandatory":false,"type":"A"},{"name":"TX60","description":"Description","length":60,"mandatory":false,"type":"A"},{"name":"CUVA","description":"Customs Value","length":18,"mandatory":false,"type":"A"},{"name":"QTY2","description":"Quantity 2","length":15,"mandatory":false,"type":"N"},{"name":"UNMS","description":"Unit of measure","length":3,"mandatory":false,"type":"A"},{"name":"PRCY","description":"Producer country","length":3,"mandatory":false,"type":"A"},{"name":"ECCN","description":"ECCN number","length":10,"mandatory":false,"type":"A"},{"name":"OCRT","description":"Origin criterion","length":15,"mandatory":false,"type":"A"},{"name":"STGE","description":"Stage","length":10,"mandatory":false,"type":"A"},{"name":"GRIN","description":"Group index","length":10,"mandatory":false,"type":"A"},{"name":"PON2","description":"PO number","length":10,"mandatory":false,"type":"A"},{"name":"IDNS","description":"Do not ship","length":1,"mandatory":false,"type":"A"}],"inputFields":[{"name":"DLIX","description":"Delivery number","length":11,"mandatory":true,"type":"N"},{"name":"BCNT","description":"Build contents flag","length":1,"mandatory":false,"type":"A"}],"utilities":[]}},"batches":{},"advancedPrograms":{}}},"utilities":{},"sources":{"202c6506-3e46-4050-9cda-327cd61c134b":{"uuid":"202c6506-3e46-4050-9cda-327cd61c134b","updated":1702539765869,"updatedBy":"ABHISHEK","created":1683571484174,"createdBy":"SADANGJ","apiVersion":"0.21","beVersion":"16.0.0.20230918173517.9","language":"GROOVY","codeHash":"8819D63A432437FB37BA34E6DC8AABBF030EE09DA6E672EB838739A6608E627B","code":"LyoqCiAqIFJFQURNRQogKiBUaGlzIGV4dGVuc2lvbiBpcyBiZWluZyB1c2VkIHRvIGxpc3QgZGF0YSBmb3IgTG9naWNvcidzIEdsb2JhbHNoaXAuIEdsb2JhbHNoaXAgaXMgYSBzaGlwcGluZyBzb2x1dGlvbiB1c2VkIGZvcgogKiBwcm9jZXNzaW5nIHNoaXBtZW50cyBvZiBvcmRlcnMgZm9yIGRlbGl2ZXJ5IHRvIGJvdGggZG9tZXN0aWMgYW5kIGludGVybmF0aW9uYWwgZGVzdGluYXRpb25zLgogKgogKiBOYW1lOiBFWFQwMTFNSS5Mc3RTaGlwbWVudAogKiBEZXNjcmlwdGlvbjogTGlzdCBkZXRhaWxzIG9mIGl0ZW1zIHRvIGJlIHNoaXBwZWQuCiAqIERhdGUgICAgICAgQ2hhbmdlZCBCeSAgICAgICAgICAgICAgICAgICAgICAgRGVzY3JpcHRpb24KICogMjAyMzA1MDggICBTdXJpeWFOQGZvcnR1ZGUuY28gICAgIEluaXRpYWwgZGV2ZWxvcG1lbnQgZnJvbSBNQUsgY1ByZXBhcmVTaGlwbWVudAogKgogKi8KaW1wb3J0IGphdmEudGltZS5Mb2NhbERhdGVUaW1lCmltcG9ydCBqYXZhLnRpbWUuZm9ybWF0LkRhdGVUaW1lRm9ybWF0dGVyCgpwdWJsaWMgY2xhc3MgTHN0U2hpcG1lbnQgZXh0ZW5kcyBFeHRlbmRNM1RyYW5zYWN0aW9uIHsKICAvL0dsb2JhbCBWYXJpYWJsZXMKICBwcml2YXRlIGZpbmFsIE1JQVBJIG1pCiAgcHJpdmF0ZSBmaW5hbCBQcm9ncmFtQVBJIHByb2dyYW0KICBwcml2YXRlIGZpbmFsIERhdGFiYXNlQVBJIGRhdGFiYXNlCiAgcHJpdmF0ZSBmaW5hbCBNSUNhbGxlckFQSSBtaUNhbGxlcgogIHByaXZhdGUgbG9uZyBpRExJWAogIHByaXZhdGUgaW50IGlDT05PLCBwaWNraW5nTGluZVN1ZmZpeCwgdHJhbnNsYXRpb25JZCwgb3JkZXJMaW5lTnVtYmVyLCBpbmRleEJveEJ5U2t1LCBvcmRlckNhdGVnb3J5LCBwbEZyb21EYXRlLCBjdXJyZW50RGF0ZSwgbWF4UGFnZVNpemUgPSAxMDAwMAogIHByaXZhdGUgYm9vbGVhbiBib3hCeUtpdCwgYm94QnlMZWFndWUsIGJveEJ5VGVhbSwgYm94QnlTdGcyLCBib3hCeVNLVSwgY2FuV0hMT1J1bkNhc2UsIGlzV0hMT1R5cGVDYXNlCiAgcHJpdmF0ZSBib29sZWFuIGlzV1VQUHJpY2VPdmVycmlkZSwgaXNERFBQcmljZU92ZXJyaWRlLCBpc01DSEVBRAogIHByaXZhdGUgU3RyaW5nICBpQkNOVCwgb3JkZXJOdW1iZXIsIHdhcmVob3VzZSwgdGVtcE9yZGVyTnVtYmVyLCBncm91cEluZGV4LCBzdGFnZSwgZGVsaXZlcnlNZXRob2QsIGNvc3RpbmdUeXBlLCB6ekZhY2lsaXR5LCB6elByaWNlTGlzdCwgb3ZlcnJpZGVDdXJyZW5jeQogIHByaXZhdGUgYm9vbGVhbiB2YWxpZElucHV0ID0gdHJ1ZQogIHByaXZhdGUgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IG9yZGVySGVhZAogIHByaXZhdGUgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IGFkZHJlc3NEYXRhCiAgcHJpdmF0ZSBIYXNoTWFwIDxTdHJpbmcsIEhhc2hNYXA8U3RyaW5nLCBTdHJpbmc+PiBhbGxvY2F0aW9uTGluZUJMVAoKICBwdWJsaWMgTHN0U2hpcG1lbnQoTUlBUEkgbWksIFByb2dyYW1BUEkgcHJvZ3JhbSwgRGF0YWJhc2VBUEkgZGF0YWJhc2UsIE1JQ2FsbGVyQVBJIG1pQ2FsbGVyKSB7CiAgICB0aGlzLm1pID0gbWkKICAgIHRoaXMucHJvZ3JhbSA9IHByb2dyYW0KICAgIHRoaXMuZGF0YWJhc2UgPSBkYXRhYmFzZQogICAgdGhpcy5taUNhbGxlciA9IG1pQ2FsbGVyCiAgfQoKICAvKioKICAgKiBNYWluIGZ1bmN0aW9uCiAgICogQHBhcmFtCiAgICogQHJldHVybgogICAqLwogIHB1YmxpYyB2b2lkIG1haW4oKSB7CiAgICBpQ09OTyA9ICBwcm9ncmFtLkxEQVpELkNPTk8gYXMgSW50ZWdlcgogICAgaURMSVggPSAobWkuaW5EYXRhLmdldCgiRExJWCIpID09IG51bGwgfHwgbWkuaW5EYXRhLmdldCgiRExJWCIpLnRyaW0oKS5pc0VtcHR5KCkpID8gMEwgOiBtaS5pbkRhdGEuZ2V0KCJETElYIikgYXMgTG9uZwogICAgaUJDTlQgPSAobWkuaW5EYXRhLmdldCgiQkNOVCIpID09IG51bGwgfHwgbWkuaW5EYXRhLmdldCgiQkNOVCIpLnRyaW0oKS5pc0VtcHR5KCkpID8gIk4iIDogbWkuaW5EYXRhLmdldCgiQkNOVCIpIGFzIFN0cmluZwogICAgdHJhbnNsYXRpb25JZCA9IDAKICAgIHBsRnJvbURhdGUgPSAwCiAgICBib3hCeUtpdCA9IGZhbHNlCiAgICBib3hCeUxlYWd1ZSA9IGZhbHNlCiAgICBib3hCeVRlYW0gPSBmYWxzZQogICAgYm94QnlTdGcyID0gZmFsc2UKICAgIGJveEJ5U0tVID0gZmFsc2UKICAgIGlzV1VQUHJpY2VPdmVycmlkZSA9IGZhbHNlCiAgICBpc0REUFByaWNlT3ZlcnJpZGUgPSBmYWxzZQogICAgaXNNQ0hFQUQgPSBmYWxzZQogICAgdmFsaWRhdGVJbnB1dChpQ09OTywgaURMSVgpIC8vQ2hlY2sgaWYgaW5wdXRzIGFyZSB2YWxpZC4KICAgIGlmICh2YWxpZElucHV0KSB7CiAgICAgIGN1cnJlbnREYXRlID0gTG9jYWxEYXRlVGltZS5ub3coKS5mb3JtYXQoRGF0ZVRpbWVGb3JtYXR0ZXIub2ZQYXR0ZXJuKCJ5eXl5TU1kZCIpKS50b0ludGVnZXIoKSAvLyBHZXQgY3VycmVudCBkYXRlCiAgICAgIG9yZGVySGVhZCA9IGdldE9yZGVySGVhZERhdGEob3JkZXJOdW1iZXIpIC8vIFJlYWQgb3JkZXIgaGVhZGVyCiAgICAgIGFkZHJlc3NEYXRhID0gZ2V0RGVsaXZlcnlBZGRyZXNzKGlETElYIGFzIFN0cmluZykgLy8gUmVhZCBkZWxpdmVyeSBhZGRyZXNzCiAgICAgIGNhbldITE9SdW5DYXNlID0gIShnZXRUcmFuc2xhdGlvbigiRldFIiArIHdhcmVob3VzZSkuZXF1YWxzSWdub3JlQ2FzZSgieSIpKQogICAgICBpc1dITE9UeXBlQ2FzZSA9ICEoZ2V0VHJhbnNsYXRpb24oIkZXVEUiICsgd2FyZWhvdXNlKS5lcXVhbHNJZ25vcmVDYXNlKCJ5IikpCiAgICAgIGNvc3RpbmdUeXBlID0gIiIKICAgICAgenpGYWNpbGl0eSA9ICIiCiAgICAgIHp6UHJpY2VMaXN0ID0gIiIKICAgICAgb3ZlcnJpZGVDdXJyZW5jeSA9ICIiCiAgICAgIC8vUHJlcGFyZSBkYXRhIGZvciBsaW5lIHByaWNlIG92ZXJyaWRlIG9mIGludGVybmF0aW9uYWwgYW5kIElQRCBzaGlwbWVudHMKICAgICAgaWYgKGlCQ05ULmVxdWFsc0lnbm9yZUNhc2UoIngiKSB8fCBpQkNOVC5lcXVhbHNJZ25vcmVDYXNlKCJ5IikgfHwgaUJDTlQuZXF1YWxzSWdub3JlQ2FzZSgieiIpKSB7CiAgICAgICAgU3RyaW5nIGZydFBvT3J0cCA9IGdldFRyYW5zbGF0aW9uKCJGUlRQT09SVFAiKQogICAgICAgIFN0cmluZyBmcnRQb0NzY2QgPSBnZXRUcmFuc2xhdGlvbigiRlJUUE9DU0NEIikKICAgICAgICBTdHJpbmcgZnJ0UG9DYXJyID0gZ2V0VHJhbnNsYXRpb24oIkZSVFBPQ0FSUiIpCiAgICAgICAgU3RyaW5nIG9ydHAgPSBvcmRlckhlYWQuZ2V0KCJPQU9SVFAiKQogICAgICAgIFN0cmluZyBjc2NkID0gYWRkcmVzc0RhdGEuZ2V0KCJDU0NEIikKICAgICAgICBTdHJpbmcgdGVkbCA9IG9yZGVySGVhZC5nZXQoIk9BVEVETCIpCiAgICAgICAgU3RyaW5nIHBycmYgPSAiIgogICAgICAgIGNvc3RpbmdUeXBlID0gZ2V0VHJhbnNsYXRpb24od2FyZWhvdXNlLnRyaW0oKSArIGRlbGl2ZXJ5TWV0aG9kLnRyaW0oKSArIGNzY2QudHJpbSgpKQogICAgICAgIHp6RmFjaWxpdHkgPSBnZXRGYWNpbGl0eSh3YXJlaG91c2UpCiAgICAgICAgaWYgKGZydFBvT3J0cC5jb250YWlucyhvcnRwLnRyaW0oKSkgJiYgIGZydFBvQ3NjZC5jb250YWlucyhjc2NkLnRyaW0oKSkgJiYgZnJ0UG9DYXJyLmNvbnRhaW5zKGRlbGl2ZXJ5TWV0aG9kLnN1YnN0cmluZygwLDEpLnRvU3RyaW5nKCkpKSB7CiAgICAgICAgICBTdHJpbmcgY3VjZCA9IG9yZGVySGVhZC5nZXQoIk9BQ1VDRCIpCiAgICAgICAgICBvdmVycmlkZUN1cnJlbmN5ID0gY3VjZC50cmltKCkKICAgICAgICAgIGlzV1VQUHJpY2VPdmVycmlkZSA9IHRydWUKICAgICAgICAgIHBycmYgPSBnZXRUcmFuc2xhdGlvbigiRlJUUE9QUlJGIikKICAgICAgICAgIHBsRnJvbURhdGUgPSBnZXRQcmljZUxpc3REYXRlKHBycmYsIGN1Y2QpCiAgICAgICAgICBpZiAocGxGcm9tRGF0ZSA9PSAwKSB7CiAgICAgICAgICAgIGlzV1VQUHJpY2VPdmVycmlkZSA9IGZhbHNlCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFN0cmluZyBmcnRERFBQTyA9IGdldFRyYW5zbGF0aW9uKCJGUlQiICsgdGVkbC50cmltKCkgKyBjc2NkLnRyaW0oKSkKICAgICAgICBpZiAoIWZydEREUFBPLmlzRW1wdHkoKSkgewogICAgICAgICAgaWYgKGNzY2QudHJpbSgpLmVxdWFscygiVVMiKSkgewogICAgICAgICAgICBpc01DSEVBRCA9IHRydWUKICAgICAgICAgIH0KICAgICAgICAgIFN0cmluZ1tdIHRva2VucyA9IGZydEREUFBPLnNwbGl0KCItIikKICAgICAgICAgIGlzRERQUHJpY2VPdmVycmlkZSA9IHRydWUKICAgICAgICAgIHBycmYgPSB0b2tlbnNbMF0udHJpbSgpCiAgICAgICAgICBvdmVycmlkZUN1cnJlbmN5ID0gdG9rZW5zWzFdLnRyaW0oKQogICAgICAgICAgaW50IGZybURhdGUgPSBnZXRQcmljZUxpc3REYXRlKHBycmYsIG92ZXJyaWRlQ3VycmVuY3kpCiAgICAgICAgICBpZiAoZnJtRGF0ZSA9PSAwKSB7CiAgICAgICAgICAgIGlzRERQUHJpY2VPdmVycmlkZSA9IGZhbHNlCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwbEZyb21EYXRlID0gZnJtRGF0ZQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB6elByaWNlTGlzdCA9IHBycmYKICAgICAgfQogICAgICAvL0NoZWNrIGZvciBzcGVjaWFsIGJveGluZyBsb2dpYwogICAgICBpZiAob3JkZXJDYXRlZ29yeSA9PSAzKSB7CiAgICAgICAgc3BlY2lhbEJveGluZ0NoZWNrKG9yZGVySGVhZCwgYWRkcmVzc0RhdGEpCiAgICAgIH0KCiAgICAgIC8vaGFuZGxlIGJveCBieSBsZWFndWUgYW5kIGJveCBieSB0ZWFtIHBhY2thZ2luZwogICAgICBpZiAoYm94QnlMZWFndWUgfHwgYm94QnlUZWFtKSB7CiAgICAgICAgYWxsb2NhdGlvbkxpbmVCTFQgPSBuZXcgSGFzaE1hcCA8U3RyaW5nLCBIYXNoTWFwPFN0cmluZywgU3RyaW5nPj4oKQogICAgICAgIG9yZGVyTGluZU51bWJlciA9IDAKICAgICAgICB0ZW1wT3JkZXJOdW1iZXIgPSBnZXRUZW1wb3JhcnlPcmRlck51bWJlcihvcmRlck51bWJlcikKICAgICAgICBFeHByZXNzaW9uRmFjdG9yeSBleHByZXNzaW9uID0gZGF0YWJhc2UuZ2V0RXhwcmVzc2lvbkZhY3RvcnkoIk1JVEFMTyIpCiAgICAgICAgZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24uZXEoIk1RUklESSIsIGlETElYIGFzIFN0cmluZykKICAgICAgICBEQkFjdGlvbiBxdWVyeSA9IGRhdGFiYXNlLnRhYmxlKCJNSVRBTE8iKS5pbmRleCgiMTAiKS5tYXRjaGluZyhleHByZXNzaW9uKS5zZWxlY3Rpb24oIk1RSVROTyIsICJNUVJJREwiLCAiTVFSSURYIiwgIk1RUkZUWCIsICJNUUNBTVUiLCAiTVFBTFFUIiwgIk1RQkFOTyIsICJNUVdIU0wiLCAiTVFSRVBOIikuYnVpbGQoKSAvL0dldCBkZWxpdmVyeSByZWxhdGVkIGluZm9ybWF0aW9uCiAgICAgICAgREJDb250YWluZXIgY29udGFpbmVyID0gcXVlcnkuZ2V0Q29udGFpbmVyKCkKICAgICAgICBjb250YWluZXIuc2V0KCJNUUNPTk8iLCBpQ09OTyBhcyBJbnRlZ2VyKQogICAgICAgIGlmIChvcmRlckNhdGVnb3J5ID09IDMpIHsKICAgICAgICAgIGNvbnRhaW5lci5zZXQoIk1RVFRZUCIsIDMxKQogICAgICAgIH0gZWxzZSBpZiAob3JkZXJDYXRlZ29yeSA9PSA1KSB7CiAgICAgICAgICBjb250YWluZXIuc2V0KCJNUVRUWVAiLCA1MSkKICAgICAgICB9IGVsc2UgaWYgKG9yZGVyQ2F0ZWdvcnkgPT0gOSkgewogICAgICAgICAgY29udGFpbmVyLnNldCgiTVFUVFlQIiwgOTIpCiAgICAgICAgfQogICAgICAgIGNvbnRhaW5lci5zZXQoIk1RUklETiIsIG9yZGVyTnVtYmVyKQogICAgICAgIGNvbnRhaW5lci5zZXQoIk1RUklETyIsIDApCiAgICAgICAgcXVlcnkucmVhZEFsbChjb250YWluZXIsIDQsbWF4UGFnZVNpemUsIGdldEFsbG9jYXRpb25MaW5lc0JMVCkKICAgICAgICBmb3IgKFN0cmluZyBrZXk6IGFsbG9jYXRpb25MaW5lQkxULmtleVNldCgpKSB7CiAgICAgICAgICBIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4gcmVjb3JkQkxUID0gYWxsb2NhdGlvbkxpbmVCTFQuZ2V0KGtleSkKICAgICAgICAgIC8vb3V0cHV0IGRhdGEKICAgICAgICAgIGJ1aWxkT3V0cHV0KHJlY29yZEJMVCkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vaGFuZGxlIGJveCBieSBraXQgcGFja2FnaW5nCiAgICAgIGlmIChib3hCeUtpdCkgewogICAgICAgIHRlbXBPcmRlck51bWJlciA9IGdldFRlbXBvcmFyeU9yZGVyTnVtYmVyKG9yZGVyTnVtYmVyKQogICAgICAgIERCQWN0aW9uIHF1ZXJ5ID0gZGF0YWJhc2UudGFibGUoIk1JVEFMTyIpLmluZGV4KCIyMCIpLnNlbGVjdGlvbigiTVFJVE5PIiwgIk1RUklETCIsICJNUVJJRFgiLCAiTVFSRlRYIiwgIk1RQ0FNVSIsICJNUUFMUVQiLCAiTVFCQU5PIiwgIk1RV0hTTCIsICJNUVJFUE4iKS5idWlsZCgpIC8vR2V0IGRlbGl2ZXJ5IHJlbGF0ZWQgaW5mb3JtYXRpb24KICAgICAgICBEQkNvbnRhaW5lciBjb250YWluZXIgPSBxdWVyeS5nZXRDb250YWluZXIoKQogICAgICAgIGNvbnRhaW5lci5zZXQoIk1RQ09OTyIsIGlDT05PIGFzIEludGVnZXIpCiAgICAgICAgaWYgKG9yZGVyQ2F0ZWdvcnkgPT0gMykgewogICAgICAgICAgY29udGFpbmVyLnNldCgiTVFUVFlQIiwgMzEpCiAgICAgICAgfSBlbHNlIGlmIChvcmRlckNhdGVnb3J5ID09IDUpIHsKICAgICAgICAgIGNvbnRhaW5lci5zZXQoIk1RVFRZUCIsIDUxKQogICAgICAgIH0gZWxzZSBpZiAob3JkZXJDYXRlZ29yeSA9PSA5KSB7CiAgICAgICAgICBjb250YWluZXIuc2V0KCJNUVRUWVAiLCA5MikKICAgICAgICB9CiAgICAgICAgY29udGFpbmVyLnNldCgiTVFSSUROIiwgb3JkZXJOdW1iZXIpCiAgICAgICAgY29udGFpbmVyLnNldCgiTVFSSURPIiwgMCkKICAgICAgICBjb250YWluZXIuc2V0KCJNUVJJREkiLCBpRExJWCBhcyBMb25nKQogICAgICAgIGNvbnRhaW5lci5zZXQoIk1RV0hMTyIsIHdhcmVob3VzZSkKICAgICAgICBjb250YWluZXIuc2V0KCJNUVBMU1giLCBwaWNraW5nTGluZVN1ZmZpeCBhcyBJbnRlZ2VyKQogICAgICAgIC8vcmVhZCBhbmQgb3V0cHV0IGRhdGEKICAgICAgICBxdWVyeS5yZWFkQWxsKGNvbnRhaW5lciwgNyxtYXhQYWdlU2l6ZSwgZ2V0QWxsb2NhdGlvbkxpbmVzQkspCiAgICAgIH0KCiAgICAgIC8vaGFuZGxlIHJlZ3VsYXIgcGFja2FnaW5nCiAgICAgIGlmICghYm94QnlMZWFndWUgJiYgIWJveEJ5VGVhbSAmJiAhYm94QnlLaXQpIHsKICAgICAgICBEQkFjdGlvbiBxdWVyeSA9IGRhdGFiYXNlLnRhYmxlKCJNSVRBTE8iKS5pbmRleCgiMjAiKS5zZWxlY3Rpb24oIk1RSVROTyIsICJNUVJJREwiLCAiTVFSSURYIiwgIk1RUkZUWCIsICJNUUNBTVUiLCAiTVFBTFFUIiwgIk1RQkFOTyIsICJNUVdIU0wiLCAiTVFSRVBOIikuYnVpbGQoKSAvL0dldCBkZWxpdmVyeSByZWxhdGVkIGluZm9ybWF0aW9uCiAgICAgICAgREJDb250YWluZXIgY29udGFpbmVyID0gcXVlcnkuZ2V0Q29udGFpbmVyKCkKICAgICAgICBjb250YWluZXIuc2V0KCJNUUNPTk8iLCBpQ09OTyBhcyBJbnRlZ2VyKQogICAgICAgIGlmIChvcmRlckNhdGVnb3J5ID09IDMpIHsKICAgICAgICAgIGNvbnRhaW5lci5zZXQoIk1RVFRZUCIsIDMxKQogICAgICAgIH0gZWxzZSBpZiAob3JkZXJDYXRlZ29yeSA9PSA1KSB7CiAgICAgICAgICBjb250YWluZXIuc2V0KCJNUVRUWVAiLCA1MSkKICAgICAgICB9IGVsc2UgaWYgKG9yZGVyQ2F0ZWdvcnkgPT0gOSkgewogICAgICAgICAgY29udGFpbmVyLnNldCgiTVFUVFlQIiwgOTIpCiAgICAgICAgfQogICAgICAgIGNvbnRhaW5lci5zZXQoIk1RUklETiIsIG9yZGVyTnVtYmVyKQogICAgICAgIGNvbnRhaW5lci5zZXQoIk1RUklETyIsIDApCiAgICAgICAgY29udGFpbmVyLnNldCgiTVFSSURJIiwgaURMSVggYXMgTG9uZykKICAgICAgICBjb250YWluZXIuc2V0KCJNUVdITE8iLCB3YXJlaG91c2UpCiAgICAgICAgY29udGFpbmVyLnNldCgiTVFQTFNYIiwgcGlja2luZ0xpbmVTdWZmaXggYXMgSW50ZWdlcikKICAgICAgICAvL3JlYWQgYW5kIG91dHB1dCBkYXRhCiAgICAgICAgcXVlcnkucmVhZEFsbChjb250YWluZXIsIDcsbWF4UGFnZVNpemUsIGdldEFsbG9jYXRpb25MaW5lcykKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuCiAgICB9CiAgfQoKICAvKioKICAgKlZhbGlkYXRlIGlucHV0cwogICAqIEBwYXJhbXMgaW50IGlDT05PLCBpbnQgRExJWAogICAqIEByZXR1cm4KICAgKi8KICBwcml2YXRlIHZhbGlkYXRlSW5wdXQoaW50IGlDT05PLCBsb25nIGlETElYKSB7CiAgICAvL1ZhbGlkYXRlIERlbGl2ZXJ5IE51bWJlcgogICAgTWFwPFN0cmluZywgU3RyaW5nPiBwYXJhbXNETElYID0gWyJDT05PIjogaUNPTk8udG9TdHJpbmcoKS50cmltKCksICJETElYIjogaURMSVgudG9TdHJpbmcoKS50cmltKCldCiAgICBDbG9zdXJlPD8+IGNhbGxiYWNrRExJWCA9IHsKICAgICAgTWFwIDwgU3RyaW5nLAogICAgICAgIFN0cmluZyA+IHJlc3BvbnNlIC0+CiAgICAgICAgaWYgKHJlc3BvbnNlLkRMSVggPT0gbnVsbCkgewogICAgICAgICAgbWkuZXJyb3IoIkludmFsaWQgZGVsaXZlcnkgTnVtYmVyICIgKyBpRExJWCkKICAgICAgICAgIHZhbGlkSW5wdXQgPSBmYWxzZQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9yZGVyTnVtYmVyID0gcmVzcG9uc2UuUklETgogICAgICAgICAgd2FyZWhvdXNlID0gcmVzcG9uc2UuV0hMTwogICAgICAgICAgcGlja2luZ0xpbmVTdWZmaXggPSByZXNwb25zZS5QTFNYIGFzIEludGVnZXIKICAgICAgICAgIG9yZGVyQ2F0ZWdvcnkgPSByZXNwb25zZS5ST1JDIGFzIEludGVnZXIKICAgICAgICAgIGRlbGl2ZXJ5TWV0aG9kID0gcmVzcG9uc2UuTU9ERgogICAgICAgICAgdmFsaWRJbnB1dCA9IHRydWUKICAgICAgICB9CiAgICB9CiAgICBtaUNhbGxlci5jYWxsKCJNV1M0MTBNSSIsICJHZXRIZWFkIiwgcGFyYW1zRExJWCwgY2FsbGJhY2tETElYKQogIH0KCiAgLy8gUmVhZCBNSVRBTE8gcmVjb3JkcyBmb3IgYm94IGJ5IGxlYWd1ZSBhbmQgdGVhbSBsb2dpYwogIENsb3N1cmU8Pz4gZ2V0QWxsb2NhdGlvbkxpbmVzQkxUID0gewogICAgREJDb250YWluZXIgY29udGFpbmVyIC0+CiAgICAgIFN0cmluZyBpdG5vID0gY29udGFpbmVyLmdldCgiTVFJVE5PIikKICAgICAgaW50IHJpZGwgPSBjb250YWluZXIuZ2V0KCJNUVJJREwiKSBhcyBJbnRlZ2VyCiAgICAgIFN0cmluZyByaWR4ID0gY29udGFpbmVyLmdldCgiTVFSSURYIikKICAgICAgU3RyaW5nIHJmdHggPSBjb250YWluZXIuZ2V0KCJNUVJGVFgiKQogICAgICBTdHJpbmcgY2FtdSA9IGNvbnRhaW5lci5nZXQoIk1RQ0FNVSIpCiAgICAgIFN0cmluZyBhbHF0ID0gY29udGFpbmVyLmdldCgiTVFBTFFUIikKICAgICAgU3RyaW5nIGJhbm8gPSBjb250YWluZXIuZ2V0KCJNUUJBTk8iKQogICAgICBTdHJpbmcgd2hzbCA9IGNvbnRhaW5lci5nZXQoIk1RV0hTTCIpCiAgICAgIFN0cmluZyByZXBuID0gY29udGFpbmVyLmdldCgiTVFSRVBOIikKICAgICAgU3RyaW5nIHJpZG4gPSBjb250YWluZXIuZ2V0KCJNUVJJRE4iKQoKICAgICAgaWYoaXRubyE9bnVsbCYmIWl0bm8udHJpbSgpLmlzRW1wdHkoKSkgewogICAgICAgIGlmIChvcmRlckxpbmVOdW1iZXIgIT0gcmlkbCkgewogICAgICAgICAgb3JkZXJMaW5lTnVtYmVyID0gcmlkbAogICAgICAgICAgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IGFsbG9jYXRpb25MaW5lID0gbmV3IEhhc2hNYXAgPFN0cmluZywgU3RyaW5nPiAoKQogICAgICAgICAgYWxsb2NhdGlvbkxpbmUucHV0KCJJVE5PIiwgaXRubykKICAgICAgICAgIGFsbG9jYXRpb25MaW5lLnB1dCgiUklETiIsIHJpZG4pCiAgICAgICAgICBhbGxvY2F0aW9uTGluZS5wdXQoIlJJREwiLCByaWRsIGFzIFN0cmluZykKICAgICAgICAgIGFsbG9jYXRpb25MaW5lLnB1dCgiUklEWCIsIHJpZHgpCiAgICAgICAgICBhbGxvY2F0aW9uTGluZS5wdXQoIlJGVFgiLCByZnR4KQogICAgICAgICAgYWxsb2NhdGlvbkxpbmUucHV0KCJDQU1VIiwgY2FtdSkKICAgICAgICAgIGFsbG9jYXRpb25MaW5lLnB1dCgiQUxRVCIsIGFscXQpCiAgICAgICAgICBhbGxvY2F0aW9uTGluZS5wdXQoIkJBTk8iLCBiYW5vKQogICAgICAgICAgYWxsb2NhdGlvbkxpbmUucHV0KCJXSFNMIiwgd2hzbCkKICAgICAgICAgIGFsbG9jYXRpb25MaW5lLnB1dCgiUkVQTiIsIHJlcG4pCiAgICAgICAgICBsaXN0Um9zdGVyTGluZXNCTFQoYWxsb2NhdGlvbkxpbmUpCiAgICAgICAgfQogICAgICB9CiAgfQoKICAvLyBSZWFkIE1JVEFMTyByZWNvcmRzIGZvciBib3ggYnkga2l0IGxvZ2ljCiAgQ2xvc3VyZTw/PiBnZXRBbGxvY2F0aW9uTGluZXNCSyA9IHsKICAgIERCQ29udGFpbmVyIGNvbnRhaW5lciAtPgogICAgICBTdHJpbmcgaXRubyA9IGNvbnRhaW5lci5nZXQoIk1RSVROTyIpCiAgICAgIGludCByaWRsID0gY29udGFpbmVyLmdldCgiTVFSSURMIikgYXMgSW50ZWdlcgogICAgICBTdHJpbmcgcmlkeCA9IGNvbnRhaW5lci5nZXQoIk1RUklEWCIpCiAgICAgIFN0cmluZyByZnR4ID0gY29udGFpbmVyLmdldCgiTVFSRlRYIikKICAgICAgU3RyaW5nIGNhbXUgPSBjb250YWluZXIuZ2V0KCJNUUNBTVUiKQogICAgICBTdHJpbmcgYWxxdCA9IGNvbnRhaW5lci5nZXQoIk1RQUxRVCIpCiAgICAgIFN0cmluZyBiYW5vID0gY29udGFpbmVyLmdldCgiTVFCQU5PIikKICAgICAgU3RyaW5nIHdoc2wgPSBjb250YWluZXIuZ2V0KCJNUVdIU0wiKQogICAgICBTdHJpbmcgcmVwbiA9IGNvbnRhaW5lci5nZXQoIk1RUkVQTiIpCiAgICAgIFN0cmluZyByaWRuID0gY29udGFpbmVyLmdldCgiTVFSSUROIikKICAgICAgaWYoaXRubyE9bnVsbCYmIWl0bm8udHJpbSgpLmlzRW1wdHkoKSkgewogICAgICAgIEhhc2hNYXAgPFN0cmluZywgU3RyaW5nPiBhbGxvY2F0aW9uTGluZSA9IG5ldyBIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4gKCkKICAgICAgICBhbGxvY2F0aW9uTGluZS5wdXQoIklUTk8iLCBpdG5vKQogICAgICAgIGFsbG9jYXRpb25MaW5lLnB1dCgiUklETiIsIHJpZG4pCiAgICAgICAgYWxsb2NhdGlvbkxpbmUucHV0KCJSSURMIiwgcmlkbCBhcyBTdHJpbmcpCiAgICAgICAgYWxsb2NhdGlvbkxpbmUucHV0KCJSSURYIiwgcmlkeCkKICAgICAgICBhbGxvY2F0aW9uTGluZS5wdXQoIlJGVFgiLCByZnR4KQogICAgICAgIGFsbG9jYXRpb25MaW5lLnB1dCgiQ0FNVSIsIGNhbXUpCiAgICAgICAgYWxsb2NhdGlvbkxpbmUucHV0KCJBTFFUIiwgYWxxdCkKICAgICAgICBhbGxvY2F0aW9uTGluZS5wdXQoIkJBTk8iLCBiYW5vKQogICAgICAgIGFsbG9jYXRpb25MaW5lLnB1dCgiV0hTTCIsIHdoc2wpCiAgICAgICAgYWxsb2NhdGlvbkxpbmUucHV0KCJSRVBOIiwgcmVwbikKICAgICAgICBsb2FkX1BPbnVtYmVyX2dyb3VwaW5kZXgoYWxsb2NhdGlvbkxpbmUpCiAgICAgIH0KICB9CgogIC8vIFJlYWQgTUlUQUxPIHJlY29yZHMgZm9yIHJlZ3VsYXIgcGFja2FnaW5nIGxvZ2ljCiAgQ2xvc3VyZTw/PiBnZXRBbGxvY2F0aW9uTGluZXMgPSB7CiAgICBEQkNvbnRhaW5lciBjb250YWluZXIgLT4KICAgICAgU3RyaW5nIGl0bm8gPSBjb250YWluZXIuZ2V0KCJNUUlUTk8iKQogICAgICBTdHJpbmcgcmlkbCA9IGNvbnRhaW5lci5nZXQoIk1RUklETCIpCiAgICAgIFN0cmluZyByaWR4ID0gY29udGFpbmVyLmdldCgiTVFSSURYIikKICAgICAgU3RyaW5nIHJmdHggPSBjb250YWluZXIuZ2V0KCJNUVJGVFgiKQogICAgICBTdHJpbmcgY2FtdSA9IGNvbnRhaW5lci5nZXQoIk1RQ0FNVSIpCiAgICAgIFN0cmluZyBhbHF0ID0gY29udGFpbmVyLmdldCgiTVFBTFFUIikKICAgICAgU3RyaW5nIGJhbm8gPSBjb250YWluZXIuZ2V0KCJNUUJBTk8iKQogICAgICBTdHJpbmcgd2hzbCA9IGNvbnRhaW5lci5nZXQoIk1RV0hTTCIpCiAgICAgIFN0cmluZyByZXBuID0gY29udGFpbmVyLmdldCgiTVFSRVBOIikKICAgICAgU3RyaW5nIHJpZG4gPSBjb250YWluZXIuZ2V0KCJNUVJJRE4iKQogICAgICBpZihpdG5vIT1udWxsJiYhaXRuby50cmltKCkuaXNFbXB0eSgpKSB7CiAgICAgICAgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IGFsbG9jYXRpb25MaW5lID0gbmV3IEhhc2hNYXAgPFN0cmluZywgU3RyaW5nPiAoKQogICAgICAgIGFsbG9jYXRpb25MaW5lLnB1dCgiSVROTyIsIGl0bm8pCiAgICAgICAgYWxsb2NhdGlvbkxpbmUucHV0KCJSSUROIiwgcmlkbikKICAgICAgICBhbGxvY2F0aW9uTGluZS5wdXQoIlJJREwiLCByaWRsKQogICAgICAgIGFsbG9jYXRpb25MaW5lLnB1dCgiUklEWCIsIHJpZHgpCiAgICAgICAgYWxsb2NhdGlvbkxpbmUucHV0KCJSRlRYIiwgIiIpCiAgICAgICAgYWxsb2NhdGlvbkxpbmUucHV0KCJDQU1VIiwgY2FtdSkKICAgICAgICBhbGxvY2F0aW9uTGluZS5wdXQoIkFMUVQiLCBhbHF0KQogICAgICAgIGFsbG9jYXRpb25MaW5lLnB1dCgiQkFOTyIsIGJhbm8pCiAgICAgICAgYWxsb2NhdGlvbkxpbmUucHV0KCJXSFNMIiwgd2hzbCkKICAgICAgICBhbGxvY2F0aW9uTGluZS5wdXQoIlJFUE4iLCByZXBuKQogICAgICAgIGJ1aWxkT3V0cHV0KGFsbG9jYXRpb25MaW5lKQogICAgICB9CiAgfQoKICAvKioKICAgKlJlYWQgdGhyb3VnaCByb3N0ZXIgbGluZSByZWNvcmRzIChFWFRTVEwpIGFuZCB1cGRhdGUgcmZ0eCBhbmQgYWxxdCB2YWx1cyBvZiBhbGxvY2F0aW9uIGxpbmUgZGF0YQogICAqIEBwYXJhbXMgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IGFsbG9jYXRpb25MaW5lCiAgICogQHJldHVybgogICAqLwogIHByaXZhdGUgdm9pZCBsaXN0Um9zdGVyTGluZXNCTFQoSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IGFsbG9jYXRpb25MaW5lKSB7CiAgICBDbG9zdXJlPD8+IGdldFJvc3RlckxpbmUgPSB7CiAgICAgIERCQ29udGFpbmVyIGNvbnRhaW5lciAtPgogICAgICAgIFN0cmluZyBwbGlkID0gY29udGFpbmVyLmdldCgiRVhQTElEIikgYXMgU3RyaW5nCiAgICAgICAgaWYocGxpZCE9bnVsbCAmJiAhcGxpZC50cmltKCkuaXNFbXB0eSgpKSB7CiAgICAgICAgICBTdHJpbmcgcmZ0eCA9IGdldFJGVFhEYXRhKHBsaWQpIC8vIHJlYWQgcmZ0eCBmcm9tIEVYVFNUSAogICAgICAgICAgU3RyaW5nIGtleSA9IGFsbG9jYXRpb25MaW5lLmdldCgiUklETiIpICsgYWxsb2NhdGlvbkxpbmUuZ2V0KCJJVE5PIikgKyByZnR4CiAgICAgICAgICBIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4gcmVjb3JkQkxUID0gYWxsb2NhdGlvbkxpbmVCTFQuZ2V0KGtleSkKICAgICAgICAgIGlmIChyZWNvcmRCTFQgPT0gbnVsbCkgewogICAgICAgICAgICBhbGxvY2F0aW9uTGluZS5wdXQoIlJGVFgiLCByZnR4KQogICAgICAgICAgICBhbGxvY2F0aW9uTGluZUJMVC5wdXQoa2V5LCBhbGxvY2F0aW9uTGluZSkKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRvdWJsZSB4eGFscXQgPSByZWNvcmRCTFQuZ2V0KCJBTFFUIikgYXMgRG91YmxlCiAgICAgICAgICAgIGRvdWJsZSB6emFscXQgPSBhbGxvY2F0aW9uTGluZS5nZXQoIkFMUVQiKSBhcyBEb3VibGUKICAgICAgICAgICAgenphbHF0ID0genphbHF0ICsgeHhhbHF0CiAgICAgICAgICAgIHJlY29yZEJMVC5wdXQoIkFMUVQiLCB6emFscXQgYXMgU3RyaW5nKQogICAgICAgICAgICBhbGxvY2F0aW9uTGluZUJMVC5wdXQoa2V5LCByZWNvcmRCTFQpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgREJBY3Rpb24gcXVlcnkgPSBkYXRhYmFzZS50YWJsZSgiRVhUU1RMIikuaW5kZXgoIjMwIikuc2VsZWN0aW9uKCJFWFBMSUQiKS5idWlsZCgpIC8vR2V0IGRlbGl2ZXJ5IHJlbGF0ZWQgaW5mb3JtYXRpb24KICAgIERCQ29udGFpbmVyIGNvbnRhaW5lciA9IHF1ZXJ5LmdldENvbnRhaW5lcigpCiAgICBjb250YWluZXIuc2V0KCJFWENPTk8iLCBpQ09OTyBhcyBJbnRlZ2VyKQogICAgY29udGFpbmVyLnNldCgiRVhESVZJIiwgb3JkZXJIZWFkLmdldCgiT0FESVZJIikudHJpbSgpKQogICAgY29udGFpbmVyLnNldCgiRVhPUk5SIiwgdGVtcE9yZGVyTnVtYmVyKQogICAgY29udGFpbmVyLnNldCgiRVhQT05SIiwgYWxsb2NhdGlvbkxpbmUuZ2V0KCJSSURMIikgYXMgSW50ZWdlcikKICAgIHF1ZXJ5LnJlYWRBbGwoY29udGFpbmVyLCA0LCBtYXhQYWdlU2l6ZSwgZ2V0Um9zdGVyTGluZSkKCiAgfQoKICAvKioKICAgKlJlYWQgdGhyb3VnaCByb3N0ZXIgbGluZSByZWNvcmRzIChFWFRTVEwpIGFuZCB1cGRhdGUgcmZ0eCwgYWxxdCwgZ3Jpbiwgc3RnZSB2YWx1cyBvZiBhbGxvY2F0aW9uIGxpbmUgZGF0YQogICAqIEBwYXJhbXMgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IGFsbG9jYXRpb25MaW5lCiAgICogQHJldHVybgogICAqLwogIHByaXZhdGUgdm9pZCBsb2FkX1BPbnVtYmVyX2dyb3VwaW5kZXgoSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IGFsbG9jYXRpb25MaW5lKSB7CiAgICBib29sZWFuIGluOTkgPSBmYWxzZQogICAgU3RyaW5nIHBvbnIgPSBhbGxvY2F0aW9uTGluZS5nZXQoIlJJREwiKQogICAgU3RyaW5nIGl0bm8gPSBhbGxvY2F0aW9uTGluZS5nZXQoIklUTk8iKQoKICAgIENsb3N1cmU8Pz4gZ2V0Um9zdGVyTGluZSA9IHsKICAgICAgREJDb250YWluZXIgY29udGFpbmVyIC0+CiAgICAgICAgU3RyaW5nIHBsaWQgPSBjb250YWluZXIuZ2V0KCJFWFBMSUQiKSBhcyBTdHJpbmcKICAgICAgICBpZihwbGlkIT1udWxsICYmICFwbGlkLnRyaW0oKS5pc0VtcHR5KCkpIHsKICAgICAgICAgIGFsbG9jYXRpb25MaW5lLnB1dCgiUkZUWCIsIHBsaWQpCiAgICAgICAgICBhbGxvY2F0aW9uTGluZS5wdXQoIkFMUVQiLCBjb250YWluZXIuZ2V0KCJFWE9SUVQiKSBhcyBTdHJpbmcpCiAgICAgICAgICBncm91cEluZGV4ID0gIiIKICAgICAgICAgIHN0YWdlID0gIiIKICAgICAgICAgIGdldFJGVFhEYXRhKHBsaWQpCiAgICAgICAgICBhbGxvY2F0aW9uTGluZS5wdXQoIkdSSU4iLCBncm91cEluZGV4IGFzIFN0cmluZykKICAgICAgICAgIGFsbG9jYXRpb25MaW5lLnB1dCgiU1RHRSIsIHN0YWdlIGFzIFN0cmluZykKICAgICAgICAgIGJ1aWxkT3V0cHV0KGFsbG9jYXRpb25MaW5lKQogICAgICAgIH0KICAgIH0KICAgIERCQWN0aW9uIHF1ZXJ5ID0gZGF0YWJhc2UudGFibGUoIkVYVFNUTCIpLmluZGV4KCIzMCIpLnNlbGVjdGlvbigiRVhQTElEIiwgIkVYT1JRVCIpLmJ1aWxkKCkgLy9HZXQgZGVsaXZlcnkgcmVsYXRlZCBpbmZvcm1hdGlvbgogICAgREJDb250YWluZXIgY29udGFpbmVyID0gcXVlcnkuZ2V0Q29udGFpbmVyKCkKICAgIGNvbnRhaW5lci5zZXQoIkVYQ09OTyIsIGlDT05PIGFzIEludGVnZXIpCiAgICBjb250YWluZXIuc2V0KCJFWERJVkkiLCBvcmRlckhlYWQuZ2V0KCJPQURJVkkiKS50cmltKCkpCiAgICBjb250YWluZXIuc2V0KCJFWE9STlIiLCB0ZW1wT3JkZXJOdW1iZXIpCiAgICBjb250YWluZXIuc2V0KCJFWFBPTlIiLCBhbGxvY2F0aW9uTGluZS5nZXQoIlJJREwiKSBhcyBJbnRlZ2VyKQogICAgY29udGFpbmVyLnNldCgiRVhQT1NYIiwgYWxsb2NhdGlvbkxpbmUuZ2V0KCJSSURYIikgYXMgSW50ZWdlcikKICAgIGNvbnRhaW5lci5zZXQoIkVYSVROTyIsIGFsbG9jYXRpb25MaW5lLmdldCgiSVROTyIpIGFzIFN0cmluZykKICAgIHF1ZXJ5LnJlYWRBbGwoY29udGFpbmVyLCA2LCBtYXhQYWdlU2l6ZSwgZ2V0Um9zdGVyTGluZSkKICB9CgogIC8qKgogICAqUmVhZCBFWFRTVEggdXNpbmcgcGxheWVyIGlkIGFzIGtleSBhbmQgcmV0dXJuIHRoZSBSRlRYIHZhbHVlLiBBbHNvLCBzZXQgZ3JvdXAgaW5kZXggYW5kIHN0YWdlIGRhdGEuCiAgICogQHBhcmFtcyBTdHJpbmcgcGxpZAogICAqIEByZXR1cm4gU3RyaW5nIHJmdHgKICAgKi8KICBwcml2YXRlIFN0cmluZyBnZXRSRlRYRGF0YShTdHJpbmcgcGxpZCkgewogICAgU3RyaW5nIHJmdHggPSAiIgogICAgREJBY3Rpb24gcXVlcnkgPSBkYXRhYmFzZS50YWJsZSgiRVhUU1RIIikuaW5kZXgoIjAwIikuc2VsZWN0aW9uKCJFWExFQUciLCAiRVhURUFNIiwgIkVYVURGMiIsICJFWFBMTk0iKS5idWlsZCgpIC8vR2V0IGRlbGl2ZXJ5IHJlbGF0ZWQgaW5mb3JtYXRpb24KICAgIERCQ29udGFpbmVyIGNvbnRhaW5lciA9IHF1ZXJ5LmdldENvbnRhaW5lcigpCiAgICBjb250YWluZXIuc2V0KCJFWENPTk8iLCBpQ09OTyBhcyBJbnRlZ2VyKQogICAgY29udGFpbmVyLnNldCgiRVhESVZJIiwgb3JkZXJIZWFkLmdldCgiT0FESVZJIikudHJpbSgpKQogICAgY29udGFpbmVyLnNldCgiRVhQTElEIiwgcGxpZCkKICAgIGlmIChxdWVyeS5yZWFkKGNvbnRhaW5lcikpIHsKICAgICAgU3RyaW5nIHBsbm0gPSBjb250YWluZXIuZ2V0KCJFWFBMTk0iKSBhcyBTdHJpbmcKICAgICAgU3RyaW5nIGxlYWcgPSBjb250YWluZXIuZ2V0KCJFWExFQUciKSBhcyBTdHJpbmcKICAgICAgU3RyaW5nIHRlYW0gPSBjb250YWluZXIuZ2V0KCJFWFRFQU0iKSBhcyBTdHJpbmcKICAgICAgaWYgKGJveEJ5TGVhZ3VlKSB7CiAgICAgICAgcmZ0eCA9IGxlYWcKICAgICAgfQogICAgICBpZiAoYm94QnlUZWFtKSB7CiAgICAgICAgcmZ0eCA9IHRlYW0KICAgICAgfQogICAgICBncm91cEluZGV4ID0gY29udGFpbmVyLmdldCgiRVhVREYyIikgYXMgU3RyaW5nCiAgICAgIHN0YWdlID0gIjEiCiAgICAgIGlmIChib3hCeVN0ZzIpIHsKICAgICAgICBwbG5tID0gcGxubS50b1VwcGVyQ2FzZSgpLnRyaW0oKQogICAgICAgIHRlYW0gPSB0ZWFtLnRvVXBwZXJDYXNlKCkudHJpbSgpCiAgICAgICAgbGVhZyA9IGxlYWcudG9VcHBlckNhc2UoKS50cmltKCkKICAgICAgICBpZiAocGxubS5lcXVhbHMoIk9USEVSIikgJiYgdGVhbS5lcXVhbHMoIk9USEVSIikgJiYgbGVhZy5lcXVhbHMoIk9USEVSIikgfHwgcGxubS5lcXVhbHMoIk9USEVSIikgJiYgbGVhZy5lcXVhbHMoIk9USEVSIikpIHsKICAgICAgICAgIHN0YWdlID0gIjIiCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmZ0eC50cmltKCkKICB9CgogIC8qKgogICAqQnVpbGQgYW5kIG91dHB1dCB0aGUgQVBJIGRhdGEgd2l0aCB0aGUgYWxsb2NhdGlvbiBsaW5lIGlucHV0LgogICAqIEBwYXJhbXMgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IGFsbG9jYXRpb25MaW5lCiAgICogQHJldHVybgogICAqLwogIHByaXZhdGUgdm9pZCBidWlsZE91dHB1dChIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4gYWxsb2NhdGlvbkxpbmUpIHsKICAgIFN0cmluZyBpdG5vID0gYWxsb2NhdGlvbkxpbmUuZ2V0KCJJVE5PIikKICAgIFN0cmluZyByaWRsID0gYWxsb2NhdGlvbkxpbmUuZ2V0KCJSSURMIikKICAgIFN0cmluZyByaWR4ID0gYWxsb2NhdGlvbkxpbmUuZ2V0KCJSSURYIikKICAgIFN0cmluZyByZnR4ID0gYWxsb2NhdGlvbkxpbmUuZ2V0KCJSRlRYIikKICAgIFN0cmluZyBjYW11ID0gYWxsb2NhdGlvbkxpbmUuZ2V0KCJDQU1VIikKICAgIFN0cmluZyBhbHF0ID0gYWxsb2NhdGlvbkxpbmUuZ2V0KCJBTFFUIikKICAgIFN0cmluZyBiYW5vID0gYWxsb2NhdGlvbkxpbmUuZ2V0KCJCQU5PIikKICAgIFN0cmluZyB3aHNsID0gYWxsb2NhdGlvbkxpbmUuZ2V0KCJXSFNMIikKICAgIFN0cmluZyByZXBuID0gYWxsb2NhdGlvbkxpbmUuZ2V0KCJSRVBOIikKICAgIFN0cmluZyByaWRuID0gYWxsb2NhdGlvbkxpbmUuZ2V0KCJSSUROIikKICAgIFN0cmluZyBzdGdlID0gYWxsb2NhdGlvbkxpbmUuZ2V0KCJTVEdFIikKICAgIFN0cmluZyBncmluID0gYWxsb2NhdGlvbkxpbmUuZ2V0KCJHUklOIikKCiAgICBpZiAoc3RnZSAhPSBudWxsKSB7CiAgICAgIG1pLm91dERhdGEucHV0KCJTVEdFIiwgc3RnZSBhcyBTdHJpbmcpCiAgICB9CiAgICBpZiAoZ3JpbiAhPSBudWxsKSB7CiAgICAgIG1pLm91dERhdGEucHV0KCJHUklOIiwgZ3JpbiBhcyBTdHJpbmcpCiAgICAgIG1pLm91dERhdGEucHV0KCJQT04yIiwgZ3JpbiBhcyBTdHJpbmcpCiAgICB9CiAgICAvL1N0YXJ0IGNvbGxlY3RpbmcgZGF0YQogICAgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IGl0ZW1EYXRhID0gZ2V0SXRlbU1hc3RlckRhdGEoaXRubykKICAgIEhhc2hNYXAgPFN0cmluZywgU3RyaW5nPiBvcmRlckxpbmUgPSBnZXRPcmRlckxpbmVEYXRhKHJpZG4sIHJpZGwgYXMgSW50ZWdlciwgcmlkeCBhcyBJbnRlZ2VyKQoKICAgIGRvdWJsZSBsaW5lT3JxdCA9IG9yZGVyTGluZS5nZXQoIk9CT1JRVCIpIGFzIGRvdWJsZQogICAgZG91YmxlIGxpbmVDaGFyZ2UgPSAwLjAKICAgIGlmIChvcmRlckNhdGVnb3J5ID09IDMpIHsKICAgICAgbGluZUNoYXJnZSA9IGdldExpbmVDaGFyZ2UocmlkbiwgcmlkbCBhcyBJbnRlZ2VyLCByaWR4IGFzIEludGVnZXIpCiAgICAgIGxpbmVDaGFyZ2UgPSBsaW5lQ2hhcmdlIC8gbGluZU9ycXQKICAgIH0KICAgIGRvdWJsZSBuZXRQcmljZSA9IG9yZGVyTGluZS5nZXQoIk9CTkVQUiIpIGFzIGRvdWJsZQogICAgZG91YmxlIGxpbmVQcmljZSA9IG5ldFByaWNlCiAgICBuZXRQcmljZSA9IChuZXRQcmljZSArIGxpbmVDaGFyZ2UpLnJvdW5kKDQpCgogICAgaWYgKGlzV1VQUHJpY2VPdmVycmlkZSB8fCBpc0REUFByaWNlT3ZlcnJpZGUpIHsKICAgICAgaWYgKGlzRERQUHJpY2VPdmVycmlkZSAmJiBpc01DSEVBRCkgewogICAgICAgIGlmICghY29zdGluZ1R5cGUuaXNFbXB0eSgpKSB7CiAgICAgICAgICBkb3VibGUgcHJpY2UgPSBnZXRDb3N0UHJpY2UoenpGYWNpbGl0eSwgaXRubywgY29zdGluZ1R5cGUpCiAgICAgICAgICBpZiAocHJpY2UgPT0gMC4wKSB7CiAgICAgICAgICAgIHByaWNlID0gZ2V0Q29zdFByaWNlKHp6RmFjaWxpdHksIGl0bm8sICIxIikKICAgICAgICAgIH0KICAgICAgICAgIGxpbmVQcmljZSA9IHByaWNlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGxpbmVQcmljZSA9IGdldENvc3RQcmljZSh6ekZhY2lsaXR5LCBpdG5vLCAiMSIpCiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGxpbmVQcmljZSA9IGdldEJhc2VQcmljZSh6elByaWNlTGlzdCwgb3ZlcnJpZGVDdXJyZW5jeSwgcGxGcm9tRGF0ZSwgaXRubykKICAgICAgfQogICAgfQoKICAgIGNhbXUgPSBjYW11LnRyaW0oKQogICAgaWYgKCFjYW11LmlzRW1wdHkoKSkgeyAgLy9XaXRoIExQTgogICAgICAvL3Byb2R1Y3RpZAogICAgICBtaS5vdXREYXRhLnB1dCgiUFJJRCIsIGl0bm8gYXMgU3RyaW5nKQogICAgICAvL3B1c2Vyc3RyaW5nMQogICAgICBTdHJpbmcgdXN0MSA9IGNhbXUKICAgICAgLy9pZiAoQ2hhcmFjdGVyLmlzRGlnaXQoY2FtdS5jaGFyQXQoMCkpKSB7CiAgICAgIC8vICB1c3QxID0gY2FtdS5zdWJzdHJpbmcoNikKICAgICAgLy99CiAgICAgIG1pLm91dERhdGEucHV0KCJVU1QxIiwgdXN0MSBhcyBTdHJpbmcpCiAgICAgIC8vcXVhbnRpdHkKICAgICAgbWkub3V0RGF0YS5wdXQoIlFUWTEiLCBhbHF0IGFzIFN0cmluZykKICAgICAgLy9wdXNlcnN0cmluZzIKICAgICAgbWkub3V0RGF0YS5wdXQoIlVTVDIiLCBuZXRQcmljZSBhcyBTdHJpbmcpCiAgICAgIGlmIChib3hCeVNLVSAmJiAoIWJveEJ5TGVhZ3VlICYmICFib3hCeVRlYW0gJiYgIWJveEJ5S2l0KSkgewogICAgICAgIGluZGV4Qm94QnlTa3UgPSBpbmRleEJveEJ5U2t1ICsgMQogICAgICAgIG1pLm91dERhdGEucHV0KCJSRlRYIiwgaW5kZXhCb3hCeVNrdSBhcyBTdHJpbmcpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy9yZWZlcmVuY2UgdGV4dAogICAgICAgIG1pLm91dERhdGEucHV0KCJSRlRYIiwgcmZ0eCBhcyBTdHJpbmcpCiAgICAgIH0KCiAgICAgIC8vYnVpbGQgY29udGVudHMKICAgICAgaWYgKGlCQ05ULmVxdWFsc0lnbm9yZUNhc2UoInkiKSB8fCBpQkNOVC5lcXVhbHNJZ25vcmVDYXNlKCJ6IikpIHsKICAgICAgICBidWlsZENvbnRlbnRzKGl0ZW1EYXRhLCBhbHF0IGFzIFN0cmluZywgbGluZVByaWNlKQogICAgICB9CiAgICAgIG1pLndyaXRlKCkKICAgIH0gZWxzZSB7IC8vTm8gTFBOCiAgICAgIFN0cmluZyBsb2NhdGlvblR5cGUgPSBnZXRMb2NhdGlvblR5cGUod2FyZWhvdXNlLCBpdG5vLCB3aHNsLCBiYW5vLCBjYW11LCByZXBuKQogICAgICAvL1NwZWNpYWwgY2FzZSBsb2dpYwogICAgICBkb3VibGUgYWxsb2NPcnF0ID0gYWxxdCBhcyBEb3VibGUKICAgICAgZG91YmxlIGNmaTIgPSBpdGVtRGF0YS5nZXQoIk1NQ0ZJMiIpIGFzIERvdWJsZQogICAgICBpbnQgY2hjZCA9IGl0ZW1EYXRhLmdldCgiTU1DSENEIikgYXMgSW50ZWdlcgogICAgICBTdHJpbmcgdGVweSA9IG9yZGVySGVhZC5nZXQoIk9BVEVQWSIpIGFzIFN0cmluZwogICAgICBpZiAoKGxpbmVPcnF0ID09IGFsbG9jT3JxdCkgJiYgKGFsbG9jT3JxdCA+PSBjZmkyKSAmJiAoY2ZpMiA+IDApICYmIChjaGNkID09IDMpICYmICghdGVweS5lcXVhbHMoIjAwMiIpICYmICF0ZXB5LmVxdWFscygiMDAzIikpICYmCiAgICAgICAgY2FuV0hMT1J1bkNhc2UgJiYgKGlzV0hMT1R5cGVDYXNlIHx8ICghaXNXSExPVHlwZUNhc2UgJiYgbG9jYXRpb25UeXBlLmVxdWFscygiMjAiKSkpKSB7CiAgICAgICAgaW50IGZ1bGwgPSAoaW50KSAoYWxsb2NPcnF0IC8gY2ZpMikgLy9HZXQgbnVtYmVyIG9mIGZ1bGwgY2FzZQogICAgICAgIGludCBwYXJ0ID0gKGludCkgKGFsbG9jT3JxdCAlIGNmaTIpIC8vR2V0IHJlbWFpbmluZyBxdWFudGl0eSB3aGljaCBpcyBub3QgZnVsbCBjYXNlCgogICAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgZnVsbDsgaSsrKSB7ICAgLy9DYXNlIHF1YW50aXR5CiAgICAgICAgICAvL3Byb2R1Y3RpZAogICAgICAgICAgbWkub3V0RGF0YS5wdXQoIlBSSUQiLCBpdG5vIGFzIFN0cmluZykKICAgICAgICAgIC8vcHVzZXJzdHJpbmcxCiAgICAgICAgICBtaS5vdXREYXRhLnB1dCgiVVNUMSIsICJDQVNFIikKICAgICAgICAgIC8vcXVhbnRpdHkKICAgICAgICAgIG1pLm91dERhdGEucHV0KCJRVFkxIiwgSW50ZWdlci50b1N0cmluZygoaW50KWNmaTIpKQogICAgICAgICAgLy9wdXNlcnN0cmluZzIKICAgICAgICAgIG1pLm91dERhdGEucHV0KCJVU1QyIiwgbmV0UHJpY2UgYXMgU3RyaW5nKQoKICAgICAgICAgIGlmIChib3hCeVNLVSAmJiAoIWJveEJ5TGVhZ3VlICYmICFib3hCeVRlYW0gJiYgIWJveEJ5S2l0KSkgewogICAgICAgICAgICBpbmRleEJveEJ5U2t1ID0gaW5kZXhCb3hCeVNrdSArIDEKICAgICAgICAgICAgbWkub3V0RGF0YS5wdXQoIlJGVFgiLCBpbmRleEJveEJ5U2t1IGFzIFN0cmluZykKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vcmVmZXJlbmNlIHRleHQKICAgICAgICAgICAgbWkub3V0RGF0YS5wdXQoIlJGVFgiLCByZnR4IGFzIFN0cmluZykKICAgICAgICAgIH0KCiAgICAgICAgICAvL2J1aWxkIGNvbnRlbnRzCiAgICAgICAgICBpZiAoaUJDTlQuZXF1YWxzSWdub3JlQ2FzZSgieSIpIHx8IGlCQ05ULmVxdWFsc0lnbm9yZUNhc2UoInoiKSkgewogICAgICAgICAgICBidWlsZENvbnRlbnRzKGl0ZW1EYXRhLCBjZmkyIGFzIFN0cmluZywgbGluZVByaWNlKQogICAgICAgICAgfQogICAgICAgICAgbWkud3JpdGUoKQogICAgICAgIH0KCiAgICAgICAgaWYgKHBhcnQgPiAwKSB7ICAgLy9SZW1haW5pbmcgcXVhbnRpdHkgd2hpY2ggaXMgbm90IGEgY2FzZSBxdWFudGl0eQogICAgICAgICAgLy9wcm9kdWN0aWQKICAgICAgICAgIG1pLm91dERhdGEucHV0KCJQUklEIiwgaXRubyBhcyBTdHJpbmcpCiAgICAgICAgICAvL3B1c2Vyc3RyaW5nMQogICAgICAgICAgbWkub3V0RGF0YS5wdXQoIlVTVDEiLCAiIikKICAgICAgICAgIC8vcXVhbnRpdHkKICAgICAgICAgIG1pLm91dERhdGEucHV0KCJRVFkxIiwgSW50ZWdlci50b1N0cmluZyhwYXJ0KSkKICAgICAgICAgIC8vcHVzZXJzdHJpbmcyCiAgICAgICAgICBtaS5vdXREYXRhLnB1dCgiVVNUMiIsIG5ldFByaWNlIGFzIFN0cmluZykKCiAgICAgICAgICBpZiAoYm94QnlTS1UgJiYgKCFib3hCeUxlYWd1ZSAmJiAhYm94QnlUZWFtICYmICFib3hCeUtpdCkpIHsKICAgICAgICAgICAgaW5kZXhCb3hCeVNrdSA9IGluZGV4Qm94QnlTa3UgKyAxCiAgICAgICAgICAgIG1pLm91dERhdGEucHV0KCJSRlRYIiwgaW5kZXhCb3hCeVNrdSBhcyBTdHJpbmcpCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvL3JlZmVyZW5jZSB0ZXh0CiAgICAgICAgICAgIG1pLm91dERhdGEucHV0KCJSRlRYIiwgcmZ0eCBhcyBTdHJpbmcpCiAgICAgICAgICB9CgogICAgICAgICAgLy9idWlsZCBjb250ZW50cwogICAgICAgICAgaWYgKGlCQ05ULmVxdWFsc0lnbm9yZUNhc2UoInkiKSB8fCBpQkNOVC5lcXVhbHNJZ25vcmVDYXNlKCJ6IikpIHsKICAgICAgICAgICAgYnVpbGRDb250ZW50cyhpdGVtRGF0YSwgcGFydCBhcyBTdHJpbmcsIGxpbmVQcmljZSkKICAgICAgICAgIH0KICAgICAgICAgIG1pLndyaXRlKCkKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy9wcm9kdWN0aWQKICAgICAgICBtaS5vdXREYXRhLnB1dCgiUFJJRCIsIGl0bm8gYXMgU3RyaW5nKQogICAgICAgIC8vcHVzZXJzdHJpbmcxCiAgICAgICAgbWkub3V0RGF0YS5wdXQoIlVTVDEiLCAiIikKICAgICAgICAvL3F1YW50aXR5CiAgICAgICAgbWkub3V0RGF0YS5wdXQoIlFUWTEiLCBhbHF0IGFzIFN0cmluZykKICAgICAgICAvL3B1c2Vyc3RyaW5nMgogICAgICAgIG1pLm91dERhdGEucHV0KCJVU1QyIiwgbmV0UHJpY2UgYXMgU3RyaW5nKQoKICAgICAgICBpZiAoYm94QnlTS1UgJiYgKCFib3hCeUxlYWd1ZSAmJiAhYm94QnlUZWFtICYmICFib3hCeUtpdCkpIHsKICAgICAgICAgIGluZGV4Qm94QnlTa3UgPSBpbmRleEJveEJ5U2t1ICsgMQogICAgICAgICAgbWkub3V0RGF0YS5wdXQoIlJGVFgiLCBpbmRleEJveEJ5U2t1IGFzIFN0cmluZykKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy9yZWZlcmVuY2UgdGV4dAogICAgICAgICAgbWkub3V0RGF0YS5wdXQoIlJGVFgiLCByZnR4IGFzIFN0cmluZykKICAgICAgICB9CgogICAgICAgIC8vYnVpbGQgY29udGVudHMKICAgICAgICBpZiAoaUJDTlQuZXF1YWxzSWdub3JlQ2FzZSgieSIpIHx8IGlCQ05ULmVxdWFsc0lnbm9yZUNhc2UoInoiKSkgewogICAgICAgICAgYnVpbGRDb250ZW50cyhpdGVtRGF0YSwgYWxxdCBhcyBTdHJpbmcsIGxpbmVQcmljZSkKICAgICAgICB9CiAgICAgICAgbWkud3JpdGUoKQogICAgICB9CiAgICB9CiAgfQoKICAvKioKICAgKlJlYWQgaXRlbSBtYXN0ZXIgZGF0YSAoTUlUTUFTKSB0byBnZXQgTU1JVERTLCBNTUlUTk8sIE1NQ0ZJMiwgTU1DSENELCBhbmQgTU1VTk1TLgogICAqIEBwYXJhbXMgU3RyaW5nIGl0ZW1OdW1iZXIKICAgKiBAcmV0dXJuIEhhc2hNYXAgPFN0cmluZywgU3RyaW5nPgogICAqLwogIHByaXZhdGUgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IGdldEl0ZW1NYXN0ZXJEYXRhIChTdHJpbmcgaXRlbU51bWJlcikgewogICAgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IGl0ZW1NYXN0ZXIgPSBuZXcgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+ICgpCiAgICBEQkFjdGlvbiBxdWVyeSA9IGRhdGFiYXNlLnRhYmxlKCJNSVRNQVMiKS5pbmRleCgiMDAiKS5zZWxlY3Rpb24oIk1NSVROTyIsICJNTUlURFMiLCAiTU1DRkkyIiwgIk1NQ0hDRCIsICJNTVVOTVMiKS5idWlsZCgpCiAgICBEQkNvbnRhaW5lciBjb250YWluZXIgPSBxdWVyeS5nZXRDb250YWluZXIoKQogICAgY29udGFpbmVyLnNldCgiTU1DT05PIiwgaUNPTk8pCiAgICBjb250YWluZXIuc2V0KCJNTUlUTk8iLCBpdGVtTnVtYmVyKQogICAgaWYgKHF1ZXJ5LnJlYWQoY29udGFpbmVyKSkgewogICAgICBpdGVtTWFzdGVyLnB1dCgiTU1JVERTIiwgY29udGFpbmVyLmdldCgiTU1JVERTIikgYXMgU3RyaW5nKQogICAgICBpdGVtTWFzdGVyLnB1dCgiTU1JVE5PIiwgY29udGFpbmVyLmdldCgiTU1JVE5PIikgYXMgU3RyaW5nKQogICAgICBpdGVtTWFzdGVyLnB1dCgiTU1DRkkyIiwgY29udGFpbmVyLmdldCgiTU1DRkkyIikgYXMgU3RyaW5nKQogICAgICBpdGVtTWFzdGVyLnB1dCgiTU1DSENEIiwgY29udGFpbmVyLmdldCgiTU1DSENEIikgYXMgU3RyaW5nKQogICAgICBpdGVtTWFzdGVyLnB1dCgiTU1VTk1TIiwgY29udGFpbmVyLmdldCgiTU1VTk1TIikgYXMgU3RyaW5nKQogICAgICBpdGVtTWFzdGVyLnB1dCgiTU1JVE5PIiwgY29udGFpbmVyLmdldCgiTU1JVE5PIikgYXMgU3RyaW5nKQogICAgfQogICAgcmV0dXJuIGl0ZW1NYXN0ZXIKICB9CgogIC8qKgogICAqUmVhZCBvcmRlciBoZWFkZXIgZGF0YSBhbmQgcmV0dXJuIHRoZW0gaW4gYSBoYXNoIG1hcAogICAqIEBwYXJhbXMgU3RyaW5nIG9yZE51bWJlcgogICAqIEByZXR1cm4gSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+CiAgICovCiAgcHJpdmF0ZSBIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4gZ2V0T3JkZXJIZWFkRGF0YShTdHJpbmcgb3JkTnVtYmVyKSB7CiAgICBIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4gb3JkZXJIZWFkID0gbmV3IEhhc2hNYXAgPFN0cmluZywgU3RyaW5nPiAoKQogICAgaWYgKG9yZGVyQ2F0ZWdvcnkgPT0gMykgewogICAgICBEQkFjdGlvbiBxdWVyeSA9IGRhdGFiYXNlLnRhYmxlKCJPT0hFQUQiKS5pbmRleCgiMDAiKS5zZWxlY3Rpb24oIk9BT1JOTyIsICJPQVRFUFkiLCAiT0FDVU5PIiwgIk9BT1JUUCIsICJPQUNVT1IiLCJPQURJVkkiLCAiT0FURURMIiwgIk9BQ1VDRCIpLmJ1aWxkKCkKICAgICAgREJDb250YWluZXIgY29udGFpbmVyID0gcXVlcnkuZ2V0Q29udGFpbmVyKCkKICAgICAgY29udGFpbmVyLnNldCgiT0FDT05PIiwgaUNPTk8pCiAgICAgIGNvbnRhaW5lci5zZXQoIk9BT1JOTyIsIG9yZE51bWJlcikKICAgICAgaWYgKHF1ZXJ5LnJlYWQoY29udGFpbmVyKSkgewogICAgICAgIG9yZGVySGVhZC5wdXQoIk9BT1JOTyIsIGNvbnRhaW5lci5nZXQoIk9BT1JOTyIpIGFzIFN0cmluZykKICAgICAgICBvcmRlckhlYWQucHV0KCJPQVRFUFkiLCBjb250YWluZXIuZ2V0KCJPQVRFUFkiKSBhcyBTdHJpbmcpCiAgICAgICAgb3JkZXJIZWFkLnB1dCgiT0FDVU5PIiwgY29udGFpbmVyLmdldCgiT0FDVU5PIikgYXMgU3RyaW5nKQogICAgICAgIG9yZGVySGVhZC5wdXQoIk9BT1JUUCIsIGNvbnRhaW5lci5nZXQoIk9BT1JUUCIpIGFzIFN0cmluZykKICAgICAgICBvcmRlckhlYWQucHV0KCJPQUNVT1IiLCBjb250YWluZXIuZ2V0KCJPQUNVT1IiKSBhcyBTdHJpbmcpCiAgICAgICAgb3JkZXJIZWFkLnB1dCgiT0FESVZJIiwgY29udGFpbmVyLmdldCgiT0FESVZJIikgYXMgU3RyaW5nKQogICAgICAgIG9yZGVySGVhZC5wdXQoIk9BVEVETCIsIGNvbnRhaW5lci5nZXQoIk9BVEVETCIpIGFzIFN0cmluZykKICAgICAgICBvcmRlckhlYWQucHV0KCJPQUNVQ0QiLCBjb250YWluZXIuZ2V0KCJPQUNVQ0QiKSBhcyBTdHJpbmcpCiAgICAgIH0KICAgIH0gZWxzZSBpZiAob3JkZXJDYXRlZ29yeSA9PSA1IHx8IG9yZGVyQ2F0ZWdvcnkgPT0gOSkgewogICAgICBEQkFjdGlvbiBxdWVyeSA9IGRhdGFiYXNlLnRhYmxlKCJNR0hFQUQiKS5pbmRleCgiMDAiKS5zZWxlY3Rpb24oIk1HVFJOUiIsICJNR1JFU1AiLCAiTUdUUlRQIiwgIk1HVEVETCIpLmJ1aWxkKCkKICAgICAgREJDb250YWluZXIgY29udGFpbmVyID0gcXVlcnkuZ2V0Q29udGFpbmVyKCkKICAgICAgY29udGFpbmVyLnNldCgiTUdDT05PIiwgaUNPTk8pCiAgICAgIGNvbnRhaW5lci5zZXQoIk1HVFJOUiIsIG9yZE51bWJlcikKICAgICAgaWYgKHF1ZXJ5LnJlYWQoY29udGFpbmVyKSkgewogICAgICAgIG9yZGVySGVhZC5wdXQoIk9BT1JOTyIsIGNvbnRhaW5lci5nZXQoIk1HVFJOUiIpIGFzIFN0cmluZykKICAgICAgICBvcmRlckhlYWQucHV0KCJPQVRFUFkiLCAiIikKICAgICAgICBvcmRlckhlYWQucHV0KCJPQUNVTk8iLCBjb250YWluZXIuZ2V0KCJNR1JFU1AiKSBhcyBTdHJpbmcpCiAgICAgICAgb3JkZXJIZWFkLnB1dCgiT0FPUlRQIiwgY29udGFpbmVyLmdldCgiTUdUUlRQIikgYXMgU3RyaW5nKQogICAgICAgIG9yZGVySGVhZC5wdXQoIk9BQ1VPUiIsIGNvbnRhaW5lci5nZXQoIk1HVFJOUiIpIGFzIFN0cmluZykKICAgICAgICBvcmRlckhlYWQucHV0KCJPQURJVkkiLCBnZXRUcmFuc2xhdGlvbigiRlJURE9ESVZJIikpCiAgICAgICAgb3JkZXJIZWFkLnB1dCgiT0FURURMIiwgY29udGFpbmVyLmdldCgiTUdURURMIikgYXMgU3RyaW5nKQogICAgICAgIG9yZGVySGVhZC5wdXQoIk9BQ1VDRCIsIGdldFRyYW5zbGF0aW9uKCJGUlRET0NVQ0QiKSkKICAgICAgfQogICAgfQogICAgcmV0dXJuIG9yZGVySGVhZAogIH0KCiAgLyoqCiAgICpSZWFkIG9yZGVyIGxpbmUgZGF0YSBhbmQgcmV0dXJuIHRoZW0gaW4gYSBoYXNoIG1hcAogICAqIEBwYXJhbXMgU3RyaW5nIG9yZE51bWJlciwgaW50IGxpbmVOdW1iZXIsIGludCBsaW5lU3VmZml4CiAgICogQHJldHVybiBIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4KICAgKi8KICBwcml2YXRlIEhhc2hNYXAgPFN0cmluZywgU3RyaW5nPiBnZXRPcmRlckxpbmVEYXRhKFN0cmluZyBvcmROdW1iZXIsIGludCBsaW5lTnVtYmVyLCBpbnQgbGluZVN1ZmZpeCkgewogICAgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IG9yZGVyTGluZSA9IG5ldyBIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4gKCkKICAgIGlmIChvcmRlckNhdGVnb3J5ID09IDMpIHsKICAgICAgREJBY3Rpb24gcXVlcnkgPSBkYXRhYmFzZS50YWJsZSgiT09MSU5FIikuaW5kZXgoIjAwIikuc2VsZWN0aW9uKCJPQk9STk8iLCAiT0JQT05SIiwgIk9CUE9TWCIsICJPQk5FUFIiLCAiT0JPUlFUIikuYnVpbGQoKQogICAgICBEQkNvbnRhaW5lciBjb250YWluZXIgPSBxdWVyeS5nZXRDb250YWluZXIoKQogICAgICBjb250YWluZXIuc2V0KCJPQkNPTk8iLCBpQ09OTykKICAgICAgY29udGFpbmVyLnNldCgiT0JPUk5PIiwgb3JkTnVtYmVyKQogICAgICBjb250YWluZXIuc2V0KCJPQlBPTlIiLCBsaW5lTnVtYmVyIGFzIEludGVnZXIpCiAgICAgIGNvbnRhaW5lci5zZXQoIk9CUE9TWCIsIGxpbmVTdWZmaXggYXMgSW50ZWdlcikKICAgICAgaWYgKHF1ZXJ5LnJlYWQoY29udGFpbmVyKSkgewogICAgICAgIG9yZGVyTGluZS5wdXQoIk9CT1JOTyIsIGNvbnRhaW5lci5nZXQoIk9CT1JOTyIpIGFzIFN0cmluZykKICAgICAgICBvcmRlckxpbmUucHV0KCJPQlBPTlIiLCBjb250YWluZXIuZ2V0KCJPQlBPTlIiKSBhcyBTdHJpbmcpCiAgICAgICAgb3JkZXJMaW5lLnB1dCgiT0JQT1NYIiwgY29udGFpbmVyLmdldCgiT0JQT1NYIikgYXMgU3RyaW5nKQogICAgICAgIG9yZGVyTGluZS5wdXQoIk9CTkVQUiIsIGNvbnRhaW5lci5nZXQoIk9CTkVQUiIpIGFzIFN0cmluZykKICAgICAgICBvcmRlckxpbmUucHV0KCJPQk9SUVQiLCBjb250YWluZXIuZ2V0KCJPQk9SUVQiKSBhcyBTdHJpbmcpCiAgICAgIH0KICAgIH0gZWxzZSBpZiAob3JkZXJDYXRlZ29yeSA9PSA1IHx8IG9yZGVyQ2F0ZWdvcnkgPT0gOSkgewogICAgICBEQkFjdGlvbiBxdWVyeSA9IGRhdGFiYXNlLnRhYmxlKCJNR0xJTkUiKS5pbmRleCgiMDAiKS5zZWxlY3Rpb24oIk1SVFJOUiIsICJNUlBPTlIiLCAiTVJQT1NYIiwgIk1SVFJQUiIsICJNUlRSUVQiKS5idWlsZCgpCiAgICAgIERCQ29udGFpbmVyIGNvbnRhaW5lciA9IHF1ZXJ5LmdldENvbnRhaW5lcigpCiAgICAgIGNvbnRhaW5lci5zZXQoIk1SQ09OTyIsIGlDT05PKQogICAgICBjb250YWluZXIuc2V0KCJNUlRSTlIiLCBvcmROdW1iZXIpCiAgICAgIGNvbnRhaW5lci5zZXQoIk1SUE9OUiIsIGxpbmVOdW1iZXIgYXMgSW50ZWdlcikKICAgICAgY29udGFpbmVyLnNldCgiTVJQT1NYIiwgbGluZVN1ZmZpeCBhcyBJbnRlZ2VyKQogICAgICBpZiAocXVlcnkucmVhZChjb250YWluZXIpKSB7CiAgICAgICAgb3JkZXJMaW5lLnB1dCgiT0JPUk5PIiwgY29udGFpbmVyLmdldCgiTVJUUk5SIikgYXMgU3RyaW5nKQogICAgICAgIG9yZGVyTGluZS5wdXQoIk9CUE9OUiIsIGNvbnRhaW5lci5nZXQoIk1SUE9OUiIpIGFzIFN0cmluZykKICAgICAgICBvcmRlckxpbmUucHV0KCJPQlBPU1giLCBjb250YWluZXIuZ2V0KCJNUlBPU1giKSBhcyBTdHJpbmcpCiAgICAgICAgb3JkZXJMaW5lLnB1dCgiT0JORVBSIiwgY29udGFpbmVyLmdldCgiTVJUUlBSIikgYXMgU3RyaW5nKQogICAgICAgIG9yZGVyTGluZS5wdXQoIk9CT1JRVCIsIGNvbnRhaW5lci5nZXQoIk1SVFJRVCIpIGFzIFN0cmluZykKICAgICAgfQogICAgfQogICAgcmV0dXJuIG9yZGVyTGluZQogIH0KCiAgLyoqCiAgICpSZWFkIHN0eWxlIGRhdGEgKE1JVE1BSCkgYW5kIHJldHVybiB0aGUgc3R5bGUgbnVtYmVyCiAgICogQHBhcmFtcyBTdHJpbmcgaXRlbU51bWJlcgogICAqIEByZXR1cm4gU3RyaW5nCiAgICovCiAgcHJpdmF0ZSBTdHJpbmcgZ2V0U3R5bGVOdW1iZXIoU3RyaW5nIGl0ZW1OdW1iZXIpIHsKICAgIFN0cmluZyBzdHlsZU51bWJlciA9IG51bGwKICAgIERCQWN0aW9uIHF1ZXJ5ID0gZGF0YWJhc2UudGFibGUoIk1JVE1BSCIpLmluZGV4KCIwMCIpLnNlbGVjdGlvbigiSE1TVFlOIikuYnVpbGQoKQogICAgREJDb250YWluZXIgY29udGFpbmVyID0gcXVlcnkuZ2V0Q29udGFpbmVyKCkKICAgIGNvbnRhaW5lci5zZXQoIkhNQ09OTyIsIGlDT05PKQogICAgY29udGFpbmVyLnNldCgiSE1JVE5PIiwgaXRlbU51bWJlcikKICAgIGlmIChxdWVyeS5yZWFkKGNvbnRhaW5lcikpIHsKICAgICAgc3R5bGVOdW1iZXIgPSBjb250YWluZXIuZ2V0KCJITVNUWU4iKQogICAgfQogICAgcmV0dXJuIHN0eWxlTnVtYmVyCiAgfQoKICAvKioKICAgKlJlYWQgc3R5bGUgbWFzdGVyIGluZm8gZGF0YSAoTU1PRE1BKSBhbmQgcmV0dXJuIGhhc2ggbWFwIGNvbnRhaW5pbmcgZGF0YSBISEZNMTUsIGFuZCBISEZNMTYKICAgKiBAcGFyYW1zIFN0cmluZyBpdGVtTnVtYmVyCiAgICogQHJldHVybiBIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4KICAgKi8KICBwcml2YXRlIEhhc2hNYXAgPFN0cmluZywgU3RyaW5nPiBnZXRTdHlsZU1hc3RlckRhdGEoU3RyaW5nIGl0ZW1OdW1iZXIpIHsKICAgIEhhc2hNYXAgPFN0cmluZywgU3RyaW5nPiBzdHlsZU1hc3RlckluZm8gPSBuZXcgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+ICgpCiAgICBTdHJpbmcgc3R5bGVOdW1iZXIgPSBnZXRTdHlsZU51bWJlcihpdGVtTnVtYmVyKQogICAgaWYgKHN0eWxlTnVtYmVyICE9IG51bGwpIHsKICAgICAgREJBY3Rpb24gcXVlcnkgPSBkYXRhYmFzZS50YWJsZSgiTU1PRE1BIikuaW5kZXgoIjAwIikuc2VsZWN0aW9uKCJISEZNMTUiLCAiSEhGTTE2IikuYnVpbGQoKQogICAgICBEQkNvbnRhaW5lciBjb250YWluZXIgPSBxdWVyeS5nZXRDb250YWluZXIoKQogICAgICBjb250YWluZXIuc2V0KCJISENPTk8iLCBpQ09OTykKICAgICAgY29udGFpbmVyLnNldCgiSEhTVFlOIiwgc3R5bGVOdW1iZXIpCiAgICAgIGlmIChxdWVyeS5yZWFkKGNvbnRhaW5lcikpIHsKICAgICAgICBzdHlsZU1hc3RlckluZm8ucHV0KCJISEZNMTUiLCBjb250YWluZXIuZ2V0KCJISEZNMTUiKSBhcyBTdHJpbmcpCiAgICAgICAgc3R5bGVNYXN0ZXJJbmZvLnB1dCgiSEhGTTE2IiwgY29udGFpbmVyLmdldCgiSEhGTTE2IikgYXMgU3RyaW5nKQogICAgICB9CiAgICB9CiAgICByZXR1cm4gc3R5bGVNYXN0ZXJJbmZvCiAgfQoKICAvKioKICAgKlJlYWQgaXRlbSBsb2NhdGlvbiBkYXRhIChNSVRMT0MpIGFuZCByZXR1cm4gbG9jYXRpb24gdHlwZSAoTUxXSExUKSBkYXRhCiAgICogQHBhcmFtcyBTdHJpbmcgd2hsbywgU3RyaW5nIGl0bm8sIFN0cmluZyB3aHNsLCBTdHJpbmcgYmFubywgU3RyaW5nIGNhbXUsIFN0cmluZyByZXBuCiAgICogQHJldHVybiBTdHJpbmcKICAgKi8KICBwcml2YXRlIFN0cmluZyBnZXRMb2NhdGlvblR5cGUoU3RyaW5nIHdobG8sIFN0cmluZyBpdG5vLCBTdHJpbmcgd2hzbCwgU3RyaW5nIGJhbm8sIFN0cmluZyBjYW11LCBTdHJpbmcgcmVwbikgewogICAgU3RyaW5nIGxvY2F0aW9uVHlwZSA9IG51bGwKICAgIERCQWN0aW9uIHF1ZXJ5ID0gZGF0YWJhc2UudGFibGUoIk1JVExPQyIpLmluZGV4KCIwMCIpLnNlbGVjdGlvbigiTUxXSExUIikuYnVpbGQoKQogICAgREJDb250YWluZXIgY29udGFpbmVyID0gcXVlcnkuZ2V0Q29udGFpbmVyKCkKICAgIGNvbnRhaW5lci5zZXQoIk1MQ09OTyIsIGlDT05PKQogICAgY29udGFpbmVyLnNldCgiTUxXSExPIiwgd2hsbykKICAgIGNvbnRhaW5lci5zZXQoIk1MSVROTyIsIGl0bm8pCiAgICBjb250YWluZXIuc2V0KCJNTFdIU0wiLCB3aHNsKQogICAgY29udGFpbmVyLnNldCgiTUxCQU5PIiwgYmFubykKICAgIGNvbnRhaW5lci5zZXQoIk1MQ0FNVSIsIGNhbXUpCiAgICBjb250YWluZXIuc2V0KCJNTFJFUE4iLCByZXBuIGFzIExvbmcpCiAgICBpZiAocXVlcnkucmVhZChjb250YWluZXIpKSB7CiAgICAgIGxvY2F0aW9uVHlwZSA9IGNvbnRhaW5lci5nZXQoIk1MV0hMVCIpCiAgICB9CiAgICByZXR1cm4gbG9jYXRpb25UeXBlCiAgfQoKICAvKioKICAgKiBidWlsZENvbnRlbnRzIC0gc2V0IHRoZSBleHRyYSBvdXRwdXQgZGF0YSBmb3IgaW50ZXJuYXRpb25hbCBkZWxpdmVyaWVzCiAgICogQHBhcmFtcyBIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4gaXRlbURhdGEsIFN0cmluZyBxdHksIGRvdWJsZSBuZXRQcmljZQogICAqIEByZXR1cm4gdm9pZAogICAqLwogIHByaXZhdGUgdm9pZCBidWlsZENvbnRlbnRzKEhhc2hNYXAgPFN0cmluZywgU3RyaW5nPiBpdGVtRGF0YSwgU3RyaW5nIHF0eSwgZG91YmxlIG5ldFByaWNlKSB7CiAgICBIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4gc3R5bGVNYXN0ZXJJbmZvID0gZ2V0U3R5bGVNYXN0ZXJEYXRhKGl0ZW1EYXRhLmdldCgiTU1JVE5PIikpCiAgICBTdHJpbmcgaHRzb3ZyY2RlID0gZ2V0VHJhbnNsYXRpb24oIkhUU09WUkNERSIpCiAgICBTdHJpbmcgaGhmbTE1ID0gc3R5bGVNYXN0ZXJJbmZvLmdldCgiSEhGTTE1IikKICAgIFN0cmluZyBoaGZtMTYgPSBzdHlsZU1hc3RlckluZm8uZ2V0KCJISEZNMTYiKQogICAgYm9vbGVhbiBpbnRsZG5zID0gZmFsc2UKICAgIC8vY29tbW9kaXR5aXRlbWNvZGUKICAgIGlmIChoaGZtMTUgPT0gbnVsbCB8fCBoaGZtMTUudHJpbSgpLmlzRW1wdHkoKSkgewogICAgICBtaS5vdXREYXRhLnB1dCgiQ0lUQyIsIGh0c292cmNkZS5zdWJzdHJpbmcoMCwgaHRzb3ZyY2RlLmxlbmd0aCgpIC0gMikpCiAgICAgIGludGxkbnMgPSB0cnVlCiAgICB9IGVsc2UgewogICAgICBtaS5vdXREYXRhLnB1dCgiQ0lUQyIsIGhoZm0xNSkKICAgIH0KICAgIC8vZGVzY3JpcHRpb24KICAgIFN0cmluZyBkZXNjcmlwdGlvbiA9IGl0ZW1EYXRhLmdldCgiTU1JVE5PIikgKyAiICIgKyBpdGVtRGF0YS5nZXQoIk1NSVREUyIpCiAgICBkZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uLnJlcGxhY2UoIiciLCAiJyciKQogICAgZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbi5yZXBsYWNlKCImIiwgImFuZCIpCiAgICBkZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uLnJlcGxhY2UoIjwiLCAibHQiKQogICAgZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbi5yZXBsYWNlKCI+IiwgImd0IikKICAgIGRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb24ucmVwbGFjZSgiIyIsICIiKQogICAgZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbi5yZXBsYWNlKCIvIiwgIiIpCiAgICBtaS5vdXREYXRhLnB1dCgiVFg2MCIsIGRlc2NyaXB0aW9uKQogICAgLy9jdXN0b21zdmFsdWUKICAgIGlmIChuZXRQcmljZSA8IDAuMDEpIHsKICAgICAgbWkub3V0RGF0YS5wdXQoIkNVVkEiLCAiMC4wMSIpCiAgICB9IGVsc2UgewogICAgICBtaS5vdXREYXRhLnB1dCgiQ1VWQSIsIG5ldFByaWNlIGFzIFN0cmluZykKICAgIH0KICAgIC8vcXVhbnRpdHkgMgogICAgbWkub3V0RGF0YS5wdXQoIlFUWTIiLCBxdHkgYXMgU3RyaW5nKQogICAgLy91bml0IG9mIG1lYXN1cmUKICAgIG1pLm91dERhdGEucHV0KCJVTk1TIiwgaXRlbURhdGEuZ2V0KCJNTVVOTVMiKSkKICAgIC8vcHJvZHVjZXJjb3VudHJ5CiAgICBpZiAoaGhmbTE2ID09IG51bGwgfHwgaGhmbTE2LnRyaW0oKS5pc0VtcHR5KCkpIHsKICAgICAgbWkub3V0RGF0YS5wdXQoIlBSQ1kiLCBodHNvdnJjZGUuc3Vic3RyaW5nKGh0c292cmNkZS5sZW5ndGgoKSAtIDIpKQogICAgICBpbnRsZG5zID0gdHJ1ZQogICAgfSBlbHNlIHsKICAgICAgbWkub3V0RGF0YS5wdXQoIlBSQ1kiLCBoaGZtMTYpCiAgICB9CiAgICAvL2VjY24gbnVtYmVyCiAgICBtaS5vdXREYXRhLnB1dCgiRUNDTiIsIGdldFRyYW5zbGF0aW9uKCJFQ0NOIikpCiAgICAvL29yaWdpbiBjcml0ZXJpb24KICAgIG1pLm91dERhdGEucHV0KCJPQ1JUIiwgIiIpCiAgICAvL0RvIG5vdCBzaGlwCiAgICBpZiAoaW50bGRucykgewogICAgICBtaS5vdXREYXRhLnB1dCgiSUROUyIsICJZIikKICAgIH0gZWxzZSB7CiAgICAgIG1pLm91dERhdGEucHV0KCJJRE5TIiwgIk4iKQogICAgfQoKICB9CgogIC8qKgogICAqIGdldExpbmVDaGFyZ2UgLSBHZXQgdGhlIHRvdGFsIGxpbmUgY2hhcmdlIGRhdGEKICAgKiBAcGFyYW1zIFN0cmluZyBvcm5vLCBpbnQgcG9uciwgaW50IHBvcwogICAqIEByZXR1cm4gZG91YmxlCiAgICovCiAgcHJpdmF0ZSBkb3VibGUgZ2V0TGluZUNoYXJnZShTdHJpbmcgb3JubywgaW50IHBvbnIsIGludCBwb3N4KSB7CiAgICBkb3VibGUgbGluZUNoYXJnZSA9IDAuMAogICAgLy9WYWxpZGF0ZSBEZWxpdmVyeSBOdW1iZXIKICAgIGRlZiBwYXJhbXNMc3RMaW5lQ2hhcmdlID0gWyJDT05PIjogaUNPTk8udG9TdHJpbmcoKS50cmltKCksICJPUk5PIjogb3Juby50b1N0cmluZygpLnRyaW0oKSwgIlBPTlIiOiBwb25yLnRvU3RyaW5nKCkudHJpbSgpLCAiUE9TWCI6IHBvc3gudG9TdHJpbmcoKS50cmltKCldCiAgICBkZWYgY2FsbGJhY2tMc3RMaW5lQ2hhcmdlID0gewogICAgICBNYXAgPCBTdHJpbmcsCiAgICAgICAgU3RyaW5nID4gcmVzcG9uc2UgLT4KICAgICAgICBpZiAocmVzcG9uc2UuQ1JJRCAhPSBudWxsKSB7CiAgICAgICAgICBkb3VibGUgcGJhbSA9IHJlc3BvbnNlLlBCQU0gYXMgZG91YmxlCiAgICAgICAgICBsaW5lQ2hhcmdlID0gbGluZUNoYXJnZSArIHBiYW0KICAgICAgICB9CiAgICB9CiAgICBtaUNhbGxlci5jYWxsKCJPSVMxMDBNSSIsICJMc3RMaW5lQ2hhcmdlIiwgcGFyYW1zTHN0TGluZUNoYXJnZSwgY2FsbGJhY2tMc3RMaW5lQ2hhcmdlKQoKICAgIHJldHVybiBsaW5lQ2hhcmdlCiAgfQoKICAvKioKICAgKiBnZXRUcmFuc2xhdGlvbiAtIEdldCB0aGUgQ1JTODgxIGRhdGEgdHJhbnNsYXRpb24gdXNpbmcgYSBTdHJpbmcga2V5d29yZAogICAqIEBwYXJhbXMgU3RyaW5nIGtleXdvcmQKICAgKiBAcmV0dXJuIFN0cmluZwogICAqLwogIHByaXZhdGUgU3RyaW5nIGdldFRyYW5zbGF0aW9uKFN0cmluZyBrZXl3b3JkKSB7CiAgICBpZiAodHJhbnNsYXRpb25JZCA9PSAwKSB7CiAgICAgIGRlZiBwYXJhbXMgPSBbIkNPTk8iOiBpQ09OTy50b1N0cmluZygpLnRyaW0oKSwiRElWSSI6IiIsIlRSUUYiOiIwIiwiTVNURCI6IlBSRVBTSElQIiwiTVZSUyI6IjEiLCJCTVNHIjoiUFJPUEVSVFkiLCJJQk9CIjoiTyIsIkVMTVAiOiJQUk9QRVJUWSIsIkVMTUQiOiJQcm9wZXJ0aWVzIl0KICAgICAgZGVmIGNhbGxiYWNrID0gewogICAgICAgIE1hcCA8IFN0cmluZywKICAgICAgICAgIFN0cmluZyA+IHJlc3BvbnNlIC0+CiAgICAgICAgICBpZiAocmVzcG9uc2UuSURUUiAhPSBudWxsKSB7CiAgICAgICAgICAgIHRyYW5zbGF0aW9uSWQgPSByZXNwb25zZS5JRFRSIGFzIEludGVnZXIKICAgICAgICAgIH0KICAgICAgfQogICAgICBtaUNhbGxlci5jYWxsKCJDUlM4ODFNSSIsICJHZXRUcmFuc2xhdGlvbiIsIHBhcmFtcywgY2FsbGJhY2spCiAgICB9CgogICAgU3RyaW5nIG1ibWQgPSAiIgogICAgaWYgKHRyYW5zbGF0aW9uSWQgIT0gMCkgewogICAgICBDbG9zdXJlPD8+IGdldFRyYW5zbGF0ZWREYXRhID0gewogICAgICAgIERCQ29udGFpbmVyIGNvbnRhaW5lciAtPgogICAgICAgICAgbWJtZCA9IGNvbnRhaW5lci5nZXQoIlRETUJNRCIpCiAgICAgICAgICBpZiAobWJtZCA9PSBudWxsKSB7CiAgICAgICAgICAgIG1ibWQgPSAiIgogICAgICAgICAgfQogICAgICB9CiAgICAgIERCQWN0aW9uIHF1ZXJ5ID0gZGF0YWJhc2UudGFibGUoIk1CTVRSRCIpLmluZGV4KCIzMCIpLnNlbGVjdGlvbigiVERNQk1EIikuYnVpbGQoKQogICAgICBEQkNvbnRhaW5lciBjb250YWluZXIgPSBxdWVyeS5nZXRDb250YWluZXIoKQogICAgICBjb250YWluZXIuc2V0KCJURENPTk8iLCBpQ09OTykKICAgICAgY29udGFpbmVyLnNldCgiVERESVZJIiwgIiIpCiAgICAgIGNvbnRhaW5lci5zZXQoIlRESURUUiIsIHRyYW5zbGF0aW9uSWQgYXMgSW50ZWdlcikKICAgICAgY29udGFpbmVyLnNldCgiVERNVlhEIixrZXl3b3JkKQogICAgICBxdWVyeS5yZWFkQWxsKGNvbnRhaW5lciwgNCwgbWF4UGFnZVNpemUsIGdldFRyYW5zbGF0ZWREYXRhKQogICAgfQogICAgcmV0dXJuIG1ibWQudHJpbSgpCiAgfQoKICAvKioKICAgKiBSZXRyaWV2ZSB0aGUgZGVsaXZlcnkgYWRkcmVzcyBkYXRhIG9mIHRoZSBvcmRlcgogICAqIEBwYXJhbXMgU3RyaW5nIGRlbGl2ZXJ5TnVtYmVyCiAgICogQHJldHVybiBIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4KICAgKi8KICBwcml2YXRlIEhhc2hNYXAgPFN0cmluZywgU3RyaW5nPiBnZXREZWxpdmVyeUFkZHJlc3MoU3RyaW5nIGRlbGl2ZXJ5TnVtYmVyKSB7CiAgICBIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4gYWRkcmVzc0RhdGEgPSBuZXcgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+ICgpCiAgICBkZWYgcGFyYW1zID0gWyJDT05PIjogaUNPTk8udG9TdHJpbmcoKS50cmltKCksIkRMSVgiOmRlbGl2ZXJ5TnVtYmVyLCJBRFJUIjoiMTEiXQogICAgZGVmIGNhbGxiYWNrID0gewogICAgICBNYXAgPCBTdHJpbmcsCiAgICAgICAgU3RyaW5nID4gcmVzcG9uc2UgLT4KICAgICAgICBpZiAocmVzcG9uc2UuQ09OQSAhPSBudWxsKSB7CiAgICAgICAgICBhZGRyZXNzRGF0YS5wdXQoIkNVQTEiLCByZXNwb25zZS5DVUExKQogICAgICAgICAgYWRkcmVzc0RhdGEucHV0KCJQT05PIiwgcmVzcG9uc2UuUE9OTykKICAgICAgICAgIGFkZHJlc3NEYXRhLnB1dCgiRUNBUiIsIHJlc3BvbnNlLkVDQVIpCiAgICAgICAgICBhZGRyZXNzRGF0YS5wdXQoIkNTQ0QiLCByZXNwb25zZS5DU0NEKQogICAgICAgIH0KICAgIH0KICAgIG1pQ2FsbGVyLmNhbGwoIk1XUzQxME1JIiwgIkdldEFkciIsIHBhcmFtcywgY2FsbGJhY2spCiAgICByZXR1cm4gYWRkcmVzc0RhdGEKICB9CgogIC8qKgogICAqIFByb2Nlc3MgaGVhZGVyLCBhZGRyZXNzLCByb3N0ZXIgZGF0YSB0byBjaGVjayBpZiBzaGlwbWVudCBzaG91bGQgYmUgcGFja2FnZWQgaW4gYSBzcGVjaWFsIGJveGluZyBsb2dpYwogICAqIEBwYXJhbXMgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IG9yZGVySGVhZCwgSGFzaE1hcCA8U3RyaW5nLCBTdHJpbmc+IGFkZHJlc3NEYXRhCiAgICogQHJldHVybiB2b2lkCiAgICovCiAgcHJpdmF0ZSB2b2lkIHNwZWNpYWxCb3hpbmdDaGVjayhIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4gb3JkZXJIZWFkLCBIYXNoTWFwIDxTdHJpbmcsIFN0cmluZz4gYWRkcmVzc0RhdGEpIHsKICAgIFN0cmluZyBjdW5vID0gb3JkZXJIZWFkLmdldCgiT0FDVU5PIikKICAgIFN0cmluZyBvcnRwID0gb3JkZXJIZWFkLmdldCgiT0FPUlRQIikKICAgIFN0cmluZyBjdWExID0gYWRkcmVzc0RhdGEuZ2V0KCJDVUExIikKICAgIFN0cmluZyBwb25vID0gYWRkcmVzc0RhdGEuZ2V0KCJQT05PIikKICAgIFN0cmluZyBlY2FyID0gYWRkcmVzc0RhdGEuZ2V0KCJFQ0FSIikKICAgIGlmIChjdWExID09IG51bGwgfHwgY3VhMS50cmltKCkuaXNFbXB0eSgpKSB7CiAgICAgIGN1YTEgPSAiWFhYWFgiCiAgICB9IGVsc2UgaWYgKGN1YTEubGVuZ3RoKCkgPj0gNSkgewogICAgICBjdWExID0gY3VhMS5zdWJzdHJpbmcoMCwgNSkudHJpbSgpCiAgICB9CgogICAgaWYgKHBvbm8gPT0gbnVsbCB8fCBwb25vLnRyaW0oKS5pc0VtcHR5KCkpIHsKICAgICAgcG9ubyA9ICJYWFhYWCIKICAgIH0gZWxzZSBpZiAocG9uby5sZW5ndGgoKSA+PSA1KSB7CiAgICAgIHBvbm8gPSBwb25vLnN1YnN0cmluZygwLCA1KS50cmltKCkKICAgIH0KICAgIGVjYXIgPSBlY2FyID09IG51bGwgPyAiIjogZWNhci50cmltKCkKICAgIFN0cmluZyBSQ1hDSEtfTVZYID0gY3Vuby50cmltKCkgKyBjdWExICsgcG9ubyArIGVjYXIKICAgIGJveEJ5U0tVID0gKGdldFRyYW5zbGF0aW9uKCJCQlMiICsgY3Vuby50cmltKCkpLmVxdWFsc0lnbm9yZUNhc2UoInkiKSkgfHwgKGdldFRyYW5zbGF0aW9uKCJCQlMiICsgUkNYQ0hLX01WWCkuZXF1YWxzSWdub3JlQ2FzZSgieSIpKQogICAgaWYgKGJveEJ5U0tVKSB7CiAgICAgIGluZGV4Qm94QnlTa3UgPSAwCiAgICB9CgogICAgLy8gT21pdCBzcGVjaWFsIGJveGluZyBwZXIgd2FyZWhvdXNlCiAgICBib29sZWFuIG9taXRTcGVjaWFsQm94aW5nID0gKGdldFRyYW5zbGF0aW9uKCJPU0IiICsgd2FyZWhvdXNlLnRyaW0oKSkuZXF1YWxzSWdub3JlQ2FzZSgieSIpKQogICAgaWYgKCFvbWl0U3BlY2lhbEJveGluZykgewogICAgICAvLyBCb3ggYnkgbGVhZ3VlIENoZWNrIC0gT3JkZXIgVHlwZSBMZXZlbAogICAgICBvcnRwID0gb3J0cCA9PSBudWxsID8gIiI6IG9ydHAudHJpbSgpCiAgICAgIGJveEJ5TGVhZ3VlID0gKGdldFRyYW5zbGF0aW9uKCJCQkwiICsgb3J0cCkuZXF1YWxzSWdub3JlQ2FzZSgieSIpKQogICAgICAvLyBCb3ggYnkga2l0IENoZWNrCiAgICAgIFN0cmluZyBjdW9yID0gb3JkZXJIZWFkLmdldCgiT0FDVU9SIikgPT0gbnVsbCA/ICIiOiBvcmRlckhlYWQuZ2V0KCJPQUNVT1IiKS50cmltKCkKICAgICAgLy9GU0N1c3RDaGsKICAgICAgYm9vbGVhbiBmU0N1c3QgPSBmYWxzZQogICAgICBpbnQgaW5kZXggPSBjdW9yLmluZGV4T2YoIi0iKQogICAgICBpZiAoaW5kZXggIT0gLTEpIHsKICAgICAgICBpbmRleCA9IGluZGV4ICsgMQogICAgICAgIGN1b3IgPSBjdW9yLnN1YnN0cmluZygwLCBpbmRleCkudHJpbSgpCiAgICAgICAgZlNDdXN0ID0gKGdldFRyYW5zbGF0aW9uKCJGU1BDIiArIGN1bm8udHJpbSgpICsgInwiICsgY3VvciArICJ8IiArIHdhcmVob3VzZS50cmltKCkpLmVxdWFsc0lnbm9yZUNhc2UoInkiKSkKICAgICAgICBpZiAoZlNDdXN0KSB7CiAgICAgICAgICBib3hCeVN0ZzIgPSAoZ2V0VHJhbnNsYXRpb24oIkJCVCIgKyBjdW5vLnRyaW0oKSkuZXF1YWxzSWdub3JlQ2FzZSgieSIpKQogICAgICAgICAgYm94QnlLaXQgPSAoZ2V0VHJhbnNsYXRpb24oIkJCSyIgKyB3YXJlaG91c2UudHJpbSgpICsgInwiICsgY3Vuby50cmltKCkpLmVxdWFsc0lnbm9yZUNhc2UoInkiKSkKICAgICAgICAgIGluZGV4ID0gMAogICAgICAgICAgU3RyaW5nIHRlYW0gPSAiIgoKICAgICAgICAgIC8vVXBkYXRlIFVERjIgZGF0YSBpbiBFWFRTVEggdGFibGUKICAgICAgICAgIENsb3N1cmU8Pz4gdXBkYXRlVURGMkNhbGxCYWNrID0geyBMb2NrZWRSZXN1bHQgbG9ja2VkUmVzdWx0IC0+CiAgICAgICAgICAgIGlmIChpbmRleCA9PSAwKSB7CiAgICAgICAgICAgICAgaW5kZXggPSBpbmRleCArIDEKICAgICAgICAgICAgICBsb2NrZWRSZXN1bHQuc2V0KCJFWFVERjIiLCBpbmRleCBhcyBTdHJpbmcpCiAgICAgICAgICAgICAgbG9ja2VkUmVzdWx0LnNldCgiRVhMTURUIiwgY3VycmVudERhdGUpCiAgICAgICAgICAgICAgaW50IGNobm8gPSBsb2NrZWRSZXN1bHQuZ2V0KCJFWENITk8iKSBhcyBJbnRlZ2VyCiAgICAgICAgICAgICAgY2hubyA9IGNobm8gKyAxCiAgICAgICAgICAgICAgbG9ja2VkUmVzdWx0LnNldCgiRVhDSE5PIiwgY2hubykKICAgICAgICAgICAgICBsb2NrZWRSZXN1bHQuc2V0KCJFWENISUQiLCBwcm9ncmFtLmdldFVzZXIoKSkKICAgICAgICAgICAgICBsb2NrZWRSZXN1bHQudXBkYXRlKCkKICAgICAgICAgICAgICB0ZWFtID0gbG9ja2VkUmVzdWx0LmdldCgiRVhURUFNIikudG9TdHJpbmcoKS50cmltKCkKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAodGVhbS5lcXVhbHMobG9ja2VkUmVzdWx0LmdldCgiRVhURUFNIikudG9TdHJpbmcoKS50cmltKCkpKSB7CiAgICAgICAgICAgICAgICBsb2NrZWRSZXN1bHQuc2V0KCJFWFVERjIiLCBpbmRleCBhcyBTdHJpbmcpCiAgICAgICAgICAgICAgICBsb2NrZWRSZXN1bHQuc2V0KCJFWExNRFQiLCBjdXJyZW50RGF0ZSkKICAgICAgICAgICAgICAgIGludCBjaG5vID0gbG9ja2VkUmVzdWx0LmdldCgiRVhDSE5PIikgYXMgSW50ZWdlcgogICAgICAgICAgICAgICAgY2hubyA9IGNobm8gKyAxCiAgICAgICAgICAgICAgICBsb2NrZWRSZXN1bHQuc2V0KCJFWENITk8iLCBjaG5vKQogICAgICAgICAgICAgICAgbG9ja2VkUmVzdWx0LnNldCgiRVhDSElEIiwgcHJvZ3JhbS5nZXRVc2VyKCkpCiAgICAgICAgICAgICAgICBsb2NrZWRSZXN1bHQudXBkYXRlKCkKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaW5kZXggPSBpbmRleCArIDEKICAgICAgICAgICAgICAgIGxvY2tlZFJlc3VsdC5zZXQoIkVYVURGMiIsIGluZGV4IGFzIFN0cmluZykKICAgICAgICAgICAgICAgIGxvY2tlZFJlc3VsdC5zZXQoIkVYTE1EVCIsIGN1cnJlbnREYXRlKQogICAgICAgICAgICAgICAgaW50IGNobm8gPSBsb2NrZWRSZXN1bHQuZ2V0KCJFWENITk8iKSBhcyBJbnRlZ2VyCiAgICAgICAgICAgICAgICBjaG5vID0gY2hubyArIDEKICAgICAgICAgICAgICAgIGxvY2tlZFJlc3VsdC5zZXQoIkVYQ0hOTyIsIGNobm8pCiAgICAgICAgICAgICAgICBsb2NrZWRSZXN1bHQuc2V0KCJFWENISUQiLCBwcm9ncmFtLmdldFVzZXIoKSkKICAgICAgICAgICAgICAgIGxvY2tlZFJlc3VsdC51cGRhdGUoKQogICAgICAgICAgICAgICAgdGVhbSA9IGxvY2tlZFJlc3VsdC5nZXQoIkVYVEVBTSIpLnRvU3RyaW5nKCkudHJpbSgpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBEQkFjdGlvbiBxdWVyeSA9IGRhdGFiYXNlLnRhYmxlKCJFWFRTVEgiKS5pbmRleCgiMTMiKS5zZWxlY3Rpb24oIkVYVEVBTSIsIkVYQ0hOTyIpLmJ1aWxkKCkKICAgICAgICAgIERCQ29udGFpbmVyIGNvbnRhaW5lciA9IHF1ZXJ5LmdldENvbnRhaW5lcigpCiAgICAgICAgICBjb250YWluZXIuc2V0KCJFWENPTk8iLCBpQ09OTykKICAgICAgICAgIGNvbnRhaW5lci5zZXQoIkVYRElWSSIsIG9yZGVySGVhZC5nZXQoIk9BRElWSSIpLnRyaW0oKSkKICAgICAgICAgIGNvbnRhaW5lci5zZXQoIkVYT1JOTyIsIG9yZGVySGVhZC5nZXQoIk9BT1JOTyIpLnRyaW0oKSkKICAgICAgICAgIHF1ZXJ5LnJlYWRBbGxMb2NrKGNvbnRhaW5lciwgMywgdXBkYXRlVURGMkNhbGxCYWNrKQogICAgICAgIH0KCiAgICAgICAgLy8gQm94IGJ5IHRlYW0gQ2hlY2sKICAgICAgICBib3hCeVRlYW0gPSBmYWxzZQogICAgICAgIGlmICghYm94QnlLaXQpIHsKICAgICAgICAgIENsb3N1cmU8Pz4gZ2V0VGVhbURhdGEgPSB7CiAgICAgICAgICAgIERCQ29udGFpbmVyIGNvbnRhaW5lciAtPgogICAgICAgICAgICAgIFN0cmluZyBncmJ5ID0gY29udGFpbmVyLmdldCgiRVhHUkJZIikudG9TdHJpbmcoKS50cmltKCkKICAgICAgICAgICAgICBpZiAoZ3JieSAhPSBudWxsICYmIGdyYnkuZXF1YWxzSWdub3JlQ2FzZSgidGVhbSIpKSB7CiAgICAgICAgICAgICAgICBib3hCeVRlYW0gPSB0cnVlCiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgREJBY3Rpb24gcXVlcnkgPSBkYXRhYmFzZS50YWJsZSgiRVhUU1RIIikuaW5kZXgoIjExIikuc2VsZWN0aW9uKCJFWEdSQlkiKS5idWlsZCgpCiAgICAgICAgICBEQkNvbnRhaW5lciBjb250YWluZXIgPSBxdWVyeS5nZXRDb250YWluZXIoKQogICAgICAgICAgY29udGFpbmVyLnNldCgiRVhDT05PIiwgaUNPTk8pCiAgICAgICAgICBjb250YWluZXIuc2V0KCJFWERJVkkiLCBvcmRlckhlYWQuZ2V0KCJPQURJVkkiKS50cmltKCkpCiAgICAgICAgICBjb250YWluZXIuc2V0KCJFWE9STk8iLCBvcmRlckhlYWQuZ2V0KCJPQU9STk8iKS50cmltKCkpCiAgICAgICAgICBxdWVyeS5yZWFkQWxsKGNvbnRhaW5lciwgMywgbWF4UGFnZVNpemUsIGdldFRlYW1EYXRhKQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgLyoqCiAgICpHZXQgVGVtcG9yYXJ5IE9yZGVyIE51bWJlciBhc3NvY2lhdGVkIHRvIGEgZmluYWwgT3JkZXIgTnVtYmVyCiAgICogQHBhcmFtcyBTdHJpbmcgUklETgogICAqIEByZXR1cm4gU3RyaW5nCiAgICovCiAgcHJpdmF0ZSBTdHJpbmcgZ2V0VGVtcG9yYXJ5T3JkZXJOdW1iZXIoU3RyaW5nIFJJRE4pIHsKICAgIFN0cmluZyBvcm5vID0gIiIKICAgIGRlZiBwYXJhbXMgPSBbIkNPTk8iOiBpQ09OTy50b1N0cmluZygpLnRyaW0oKSwiT1JOTyI6UklETi50b1N0cmluZygpLnRyaW0oKV0KICAgIGRlZiBjYWxsYmFjayA9IHsKICAgICAgTWFwIDwgU3RyaW5nLAogICAgICAgIFN0cmluZyA+IHJlc3BvbnNlIC0+CiAgICAgICAgaWYgKHJlc3BvbnNlLk9STk8gIT0gbnVsbCkgewogICAgICAgICAgb3JubyA9IHJlc3BvbnNlLk9STk8KICAgICAgICB9CiAgICB9CiAgICBtaUNhbGxlci5jYWxsKCJPSVMyNzVNSSIsICJHZXRUbXBPcmRlclN0YXQiLCBwYXJhbXMsIGNhbGxiYWNrKQogICAgcmV0dXJuIG9ybm8KICB9CgogIC8qKgogICAqR2V0IGNvc3RpbmcgcHJpY2UgZnJvbSBNQ0hFQUQKICAgKiBAcGFyYW1zIFN0cmluZyBmYWNpbGl0eSwgU3RyaW5nIGl0ZW1OdW1iZXIsIFN0cmluZyBjb3N0VHlwZQogICAqIEByZXR1cm4gZG91YmxlCiAgICovCiAgcHJpdmF0ZSBkb3VibGUgZ2V0Q29zdFByaWNlKFN0cmluZyBmYWNpbGl0eSwgU3RyaW5nIGl0ZW1OdW1iZXIsIFN0cmluZyBjb3N0VHlwZSkgewogICAgZG91YmxlIGNvc3RQcmljZSA9IDAuMAogICAgQ2xvc3VyZTw/PiBnZXRDb3N0aW5nID0gewogICAgICBEQkNvbnRhaW5lciBjb250YWluZXIgLT4KICAgICAgICBpbnQgY29zdERhdGUgPSBjb250YWluZXIuZ2V0KCJLT1BDRFQiKSBhcyBJbnRlZ2VyCiAgICAgICAgaWYgKGNvc3REYXRlID4gMCAmJiBjdXJyZW50RGF0ZSA+PSBjb3N0RGF0ZSkgewogICAgICAgICAgY29zdFByaWNlID0gY29udGFpbmVyLmdldCgiS09DU1UxIikgYXMgRG91YmxlCiAgICAgICAgfQogICAgfQogICAgREJBY3Rpb24gcXVlcnkgPSBkYXRhYmFzZS50YWJsZSgiTUNIRUFEIikuaW5kZXgoIjAwIikuc2VsZWN0aW9uKCJLT1BDRFQiLCAiS09DU1UxIikuYnVpbGQoKQogICAgREJDb250YWluZXIgY29udGFpbmVyID0gcXVlcnkuZ2V0Q29udGFpbmVyKCkKICAgIGNvbnRhaW5lci5zZXQoIktPQ09OTyIsIGlDT05PKQogICAgY29udGFpbmVyLnNldCgiS09GQUNJIiwgZmFjaWxpdHkpCiAgICBjb250YWluZXIuc2V0KCJLT0lUTk8iLCBpdGVtTnVtYmVyKQogICAgY29udGFpbmVyLnNldCgiS09TVFJUIiwgIiIpCiAgICBjb250YWluZXIuc2V0KCJLT1ZBU0UiLCAiIikKICAgIGNvbnRhaW5lci5zZXQoIktPQ1JPQyIsIDApCiAgICBjb250YWluZXIuc2V0KCJLT1JPUk4iLCAiIikKICAgIGNvbnRhaW5lci5zZXQoIktPUk9STCIsIDApCiAgICBjb250YWluZXIuc2V0KCJLT1JPUlgiLCAwKQogICAgY29udGFpbmVyLnNldCgiS09FQ1ZTIiwgMCkKICAgIGNvbnRhaW5lci5zZXQoIktPU01GTiIsICIiKQogICAgY29udGFpbmVyLnNldCgiS09QQ1RQIiwgY29zdFR5cGUpCiAgICBxdWVyeS5yZWFkQWxsKGNvbnRhaW5lciwgMTIsIG1heFBhZ2VTaXplLCBnZXRDb3N0aW5nKQogICAgcmV0dXJuIGNvc3RQcmljZQogIH0KICAKICAvKioKICAqR2V0IHRoZSBwcmljZSBsaXN0IGRhdGUgZm9yIHRoZSBwcmljZSBsaXN0IGFuZCBDdXJyZW5jeQogICpAcGFyYW1zIFByaWNlTGlzdCAoU3RyaW5nKSwgQ3VycmVuY3koU3RpcmluZykKICAqQHJldHVybiBpbnQKICAqLwogIHByaXZhdGUgaW50IGdldFByaWNlTGlzdERhdGUoU3RyaW5nIHByaWNlTGlzdCwgU3RyaW5nIGN1cnJlbmN5KSB7CiAgICBpbnQgZnJvbURhdGUgPSAwCiAgICBDbG9zdXJlPD8+IGdldFByaWNlTGlzdCA9IHsKICAgICAgREJDb250YWluZXIgY29udGFpbmVyIC0+CiAgICAgICAgaW50IGZ2RGF0ZSA9IGNvbnRhaW5lci5nZXQoIk9KRlZEVCIpCiAgICAgICAgaWYgKGZ2RGF0ZSA+IDAgJiYgY3VycmVudERhdGUgPj0gZnZEYXRlKSB7CiAgICAgICAgICBmcm9tRGF0ZSA9IGZ2RGF0ZQogICAgICAgIH0KICAgIH0KICAgIERCQWN0aW9uIHF1ZXJ5ID0gZGF0YWJhc2UudGFibGUoIk9QUklDSCIpLmluZGV4KCIwMCIpLnNlbGVjdGlvbigiT0pGVkRUIikuYnVpbGQoKQogICAgREJDb250YWluZXIgY29udGFpbmVyID0gcXVlcnkuZ2V0Q29udGFpbmVyKCkKICAgIGNvbnRhaW5lci5zZXQoIk9KQ09OTyIsIGlDT05PKQogICAgY29udGFpbmVyLnNldCgiT0pQUlJGIiwgcHJpY2VMaXN0KQogICAgY29udGFpbmVyLnNldCgiT0pDVUNEIiwgY3VycmVuY3kpCiAgICBjb250YWluZXIuc2V0KCJPSkNVTk8iLCAiIikKICAgIHF1ZXJ5LnJlYWRBbGwoY29udGFpbmVyLCA0LCBtYXhQYWdlU2l6ZSwgZ2V0UHJpY2VMaXN0KQogICAgcmV0dXJuIGZyb21EYXRlCiAgfQoKICAvKioKICAgKkdldCBiYXNlIHNhbGVzIHByaWNlIHVzaW5nIE9JUzAxN01JLkdldEJhc2VQcmljZSBjYWxsCiAgICogQHBhcmFtcyBTdHJpbmcgcHJpY2VMaXN0LCBTdHJpbmcgY3VycmVuY3ksIGludCBmcm9tRGF0ZSwgU3RyaW5nIGl0ZW1OdW1iZXIKICAgKiBAcmV0dXJuIGRvdWJsZQogICAqLwogIHByaXZhdGUgZG91YmxlIGdldEJhc2VQcmljZShTdHJpbmcgcHJpY2VMaXN0LCBTdHJpbmcgY3VycmVuY3ksIGludCBmcm9tRGF0ZSwgU3RyaW5nIGl0ZW1OdW1iZXIpIHsKICAgIGRvdWJsZSBiYXNlUHJpY2UgPSAwLjAKICAgIGRlZiBwYXJhbXMgPSBbIkNPTk8iOiBpQ09OTy50b1N0cmluZygpLnRyaW0oKSwiUFJSRiI6IHByaWNlTGlzdCwiQ1VOTyI6ICIiLCJDVUNEIjpjdXJyZW5jeSwiRlZEVCI6IGZyb21EYXRlIGFzIFN0cmluZywiSVROTyI6IGl0ZW1OdW1iZXJdCiAgICBkZWYgY2FsbGJhY2sgPSB7CiAgICAgIE1hcCA8IFN0cmluZywKICAgICAgICBTdHJpbmcgPiByZXNwb25zZSAtPgogICAgICAgIGlmIChyZXNwb25zZS5TQVBSICE9IG51bGwpIHsKICAgICAgICAgIGJhc2VQcmljZSA9IHJlc3BvbnNlLlNBUFIgYXMgRG91YmxlCiAgICAgICAgfQogICAgfQogICAgbWlDYWxsZXIuY2FsbCgiT0lTMDE3TUkiLCAiR2V0QmFzZVByaWNlIiwgcGFyYW1zLCBjYWxsYmFjaykKICAgIHJldHVybiBiYXNlUHJpY2UKICB9CgogIC8qKgogICAqR2V0IEZhY2lsaXR5IGRhdGEgYXNzb2NpYXRlZCBmb3IgYSB3YXJlaG91c2UKICAgKiBAcGFyYW1zIFN0cmluZyB3aGxvCiAgICogQHJldHVybiBTdHJpbmcKICAgKi8KICBwcml2YXRlIFN0cmluZyBnZXRGYWNpbGl0eShTdHJpbmcgd2hsbykgewogICAgU3RyaW5nIGZhY2lsaXR5ID0gIiIKICAgIERCQWN0aW9uIHF1ZXJ5ID0gZGF0YWJhc2UudGFibGUoIk1JVFdITCIpLmluZGV4KCIwMCIpLnNlbGVjdGlvbigiTVdXSExPIiwgIk1XRkFDSSIpLmJ1aWxkKCkKICAgIERCQ29udGFpbmVyIGNvbnRhaW5lciA9IHF1ZXJ5LmdldENvbnRhaW5lcigpCiAgICBjb250YWluZXIuc2V0KCJNV0NPTk8iLCBpQ09OTykKICAgIGNvbnRhaW5lci5zZXQoIk1XV0hMTyIsIHdobG8pCiAgICBpZiAocXVlcnkucmVhZChjb250YWluZXIpKSB7CiAgICAgIGZhY2lsaXR5ID0gY29udGFpbmVyLmdldCgiTVdGQUNJIikKICAgIH0KICAgIHJldHVybiBmYWNpbGl0eQogIH0KfQo="}}}